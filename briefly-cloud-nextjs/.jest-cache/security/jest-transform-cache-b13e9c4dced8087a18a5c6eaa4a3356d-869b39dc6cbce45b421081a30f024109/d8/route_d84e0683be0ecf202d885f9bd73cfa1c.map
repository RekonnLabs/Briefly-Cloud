{"version":3,"names":["cov_8h0y9ec98","actualCoverage","s","GET","listGoogleFilesHandler","_request","context","f","user","b","_apiutils","ApiResponse","unauthorized","data","token","_supabase","supabaseAdmin","from","select","eq","id","single","access_token","badRequest","oauth2Client","_googleapis","google","auth","OAuth2","setCredentials","refresh_token","drive","version","res","files","list","pageSize","fields","q","success","_apimiddleware","createProtectedApiHandler","rateLimit","_ratelimit","rateLimitConfigs","general","logging","enabled","includeBody"],"sources":["R:\\Apps\\Briefly_Cloud\\briefly-cloud-nextjs\\src\\app\\api\\storage\\google\\list\\route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\r\nimport { createProtectedApiHandler, ApiContext } from '@/app/lib/api-middleware'\r\nimport { ApiResponse } from '@/app/lib/api-utils'\r\nimport { rateLimitConfigs } from '@/app/lib/rate-limit'\r\nimport { google } from 'googleapis'\r\nimport { supabaseAdmin } from '@/app/lib/supabase'\r\n\r\nasync function listGoogleFilesHandler(_request: Request, context: ApiContext): Promise<NextResponse> {\r\n  const { user } = context\r\n  if (!user) return ApiResponse.unauthorized('User not authenticated')\r\n\r\n  const { data: token } = await supabaseAdmin\r\n    .from('oauth_tokens')\r\n    .select('*')\r\n    .eq('user_id', user.id)\r\n    .eq('provider', 'google')\r\n    .single()\r\n\r\n  if (!token?.access_token) return ApiResponse.badRequest('Google account not connected')\r\n\r\n  const oauth2Client = new google.auth.OAuth2()\r\n  oauth2Client.setCredentials({\r\n    access_token: token.access_token,\r\n    refresh_token: token.refresh_token,\r\n  })\r\n\r\n  const drive = google.drive({ version: 'v3', auth: oauth2Client })\r\n  const res = await drive.files.list({\r\n    pageSize: 50,\r\n    fields: 'files(id, name, mimeType, size, webViewLink)',\r\n    q: \"mimeType != 'application/vnd.google-apps.folder'\",\r\n  })\r\n\r\n  return ApiResponse.success({ files: res.data.files || [] })\r\n}\r\n\r\nexport const GET = createProtectedApiHandler(listGoogleFilesHandler, {\r\n  rateLimit: rateLimitConfigs.general,\r\n  logging: { enabled: true, includeBody: false },\r\n})\r\n\r\n\r\n\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAOA;IAAAA,aAAA,YAAAA,CAAA;MAAA,OAAAC,cAAA;IAAA;EAAA;EAAA,OAAAA,cAAA;AAAA;AAAAD,aAAA;AAAAA,aAAA,GAAAE,CAAA;;;;;;+BA6Ba;;;;;;WAAAC,GAAA;;;;;iCAnCyC;;;iCAC1B;;;iCACK;;;iCACV;;;iCACO;AAE9B,eAAeC,uBAAuBC,QAAiB,EAAEC,OAAmB;EAAA;EAAAN,aAAA,GAAAO,CAAA;EAC1E,MAAM;IAAEC;EAAI,CAAE;EAAA;EAAA,CAAAR,aAAA,GAAAE,CAAA,OAAGI,OAAA;EAAA;EAAAN,aAAA,GAAAE,CAAA;EACjB,IAAI,CAACM,IAAA,EAAM;IAAA;IAAAR,aAAA,GAAAS,CAAA;IAAAT,aAAA,GAAAE,CAAA;IAAA,OAAOQ,SAAA,CAAAC,WAAW,CAACC,YAAY,CAAC;EAAA;EAAA;EAAA;IAAAZ,aAAA,GAAAS,CAAA;EAAA;EAE3C,MAAM;IAAEI,IAAA,EAAMC;EAAK,CAAE;EAAA;EAAA,CAAAd,aAAA,GAAAE,CAAA,QAAG,MAAMa,SAAA,CAAAC,aAAa,CACxCC,IAAI,CAAC,gBACLC,MAAM,CAAC,KACPC,EAAE,CAAC,WAAWX,IAAA,CAAKY,EAAE,EACrBD,EAAE,CAAC,YAAY,UACfE,MAAM;EAAA;EAAArB,aAAA,GAAAE,CAAA;EAET,IAAI,CAACY,KAAA,EAAOQ,YAAA,EAAc;IAAA;IAAAtB,aAAA,GAAAS,CAAA;IAAAT,aAAA,GAAAE,CAAA;IAAA,OAAOQ,SAAA,CAAAC,WAAW,CAACY,UAAU,CAAC;EAAA;EAAA;EAAA;IAAAvB,aAAA,GAAAS,CAAA;EAAA;EAExD,MAAMe,YAAA;EAAA;EAAA,CAAAxB,aAAA,GAAAE,CAAA,QAAe,IAAIuB,WAAA,CAAAC,MAAM,CAACC,IAAI,CAACC,MAAM;EAAA;EAAA5B,aAAA,GAAAE,CAAA;EAC3CsB,YAAA,CAAaK,cAAc,CAAC;IAC1BP,YAAA,EAAcR,KAAA,CAAMQ,YAAY;IAChCQ,aAAA,EAAehB,KAAA,CAAMgB;EACvB;EAEA,MAAMC,KAAA;EAAA;EAAA,CAAA/B,aAAA,GAAAE,CAAA,QAAQuB,WAAA,CAAAC,MAAM,CAACK,KAAK,CAAC;IAAEC,OAAA,EAAS;IAAML,IAAA,EAAMH;EAAa;EAC/D,MAAMS,GAAA;EAAA;EAAA,CAAAjC,aAAA,GAAAE,CAAA,QAAM,MAAM6B,KAAA,CAAMG,KAAK,CAACC,IAAI,CAAC;IACjCC,QAAA,EAAU;IACVC,MAAA,EAAQ;IACRC,CAAA,EAAG;EACL;EAAA;EAAAtC,aAAA,GAAAE,CAAA;EAEA,OAAOQ,SAAA,CAAAC,WAAW,CAAC4B,OAAO,CAAC;IAAEL,KAAA;IAAO;IAAA,CAAAlC,aAAA,GAAAS,CAAA,UAAAwB,GAAA,CAAIpB,IAAI,CAACqB,KAAK;IAAA;IAAA,CAAAlC,aAAA,GAAAS,CAAA,UAAI,EAAE;EAAC;AAC3D;AAEO,MAAMN,GAAA;AAAA;AAAA,CAAAH,aAAA,GAAAE,CAAA,QAAM,IAAAsC,cAAA,CAAAC,yBAAyB,EAACrC,sBAAA,EAAwB;EACnEsC,SAAA,EAAWC,UAAA,CAAAC,gBAAgB,CAACC,OAAO;EACnCC,OAAA,EAAS;IAAEC,OAAA,EAAS;IAAMC,WAAA,EAAa;EAAM;AAC/C","ignoreList":[]}