{"version":3,"names":["POST","cov_ud05i4cwd","f","s","dynamic","request","sig","headers","get","secret","process","env","STRIPE_WEBHOOK_SECRET","stripe","_stripe","default","STRIPE_SECRET_KEY","apiVersion","body","text","event","webhooks","constructEvent","err","_server","NextResponse","json","error","status","supabase","_supabase","supabaseAdmin","type","b","session","data","object","userId","metadata","user_id","tier","from","update","subscription_tier","subscription_status","eq","subscription","customerId","customer","match","select","single","id","received","e"],"sources":["R:\\Apps\\Briefly_Cloud\\briefly-cloud-nextjs\\src\\app\\api\\billing\\webhook\\route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\r\nimport Stripe from 'stripe'\r\nimport { supabaseAdmin } from '@/app/lib/supabase'\r\n\r\nexport const dynamic = 'force-dynamic'\r\n\r\nexport async function POST(request: Request) {\r\n  const sig = request.headers.get('stripe-signature')\r\n  const secret = process.env.STRIPE_WEBHOOK_SECRET!\r\n  const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, { apiVersion: '2024-06-20' })\r\n\r\n  const body = await request.text()\r\n\r\n  let event: Stripe.Event\r\n  try {\r\n    event = stripe.webhooks.constructEvent(body, sig!, secret)\r\n  } catch (err) {\r\n    return NextResponse.json({ error: 'Invalid signature' }, { status: 400 })\r\n  }\r\n\r\n  const supabase = supabaseAdmin\r\n\r\n  try {\r\n    switch (event.type) {\r\n      case 'checkout.session.completed': {\r\n        const session = event.data.object as Stripe.Checkout.Session\r\n        const userId = (session.metadata as any)?.user_id\r\n        const tier = (session.metadata as any)?.tier\r\n        if (userId && tier) {\r\n          await supabase.from('users').update({ subscription_tier: tier, subscription_status: 'active' }).eq('id', userId)\r\n        }\r\n        break\r\n      }\r\n      case 'customer.subscription.deleted': {\r\n        const subscription = event.data.object as Stripe.Subscription\r\n        const customerId = subscription.customer as string\r\n        const { data: match } = await supabase.from('users').select('id').eq('stripe_customer_id', customerId).single()\r\n        if (match?.id) {\r\n          await supabase.from('users').update({ subscription_tier: 'free', subscription_status: 'canceled' }).eq('id', match.id)\r\n        }\r\n        break\r\n      }\r\n      default:\r\n        break\r\n    }\r\n    return NextResponse.json({ received: true })\r\n  } catch (e) {\r\n    return NextResponse.json({ error: 'Webhook error' }, { status: 400 })\r\n  }\r\n}\r\n\r\n\r\n\r\n"],"mappings":"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","ignoreList":[]}