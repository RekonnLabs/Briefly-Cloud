{"version":3,"names":["GET","cov_2lvaq6c4hi","f","s","POST","PUT","GetNotificationsSchema","_zod","z","object","limit","number","min","max","optional","default","offset","unread_only","boolean","MarkReadSchema","notification_id","string","uuid","UpdatePreferencesSchema","email_notifications","in_app_notifications","migration_updates","maintenance_alerts","feature_updates","security_alerts","request","_ratelimit","withRateLimit","session","_nextauth","getServerSession","_auth","authOptions","user","b","_apierrors","formatErrorResponse","searchParams","URL","url","query","parseInt","get","validatedQuery","parse","notificationManager","_notifications","NotificationManager","process","env","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_SERVICE_ROLE_KEY","notifications","getUserNotifications","id","filteredNotifications","filter","n","read_at","_server","NextResponse","json","success","data","count","length","has_more","error","_logger","logger","body","markNotificationAsRead","message","preferences","updateNotificationPreferences"],"sources":["R:\\Apps\\Briefly_Cloud\\briefly-cloud-nextjs\\src\\app\\api\\notifications\\route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\r\nimport { getServerSession } from 'next-auth'\r\nimport { authOptions } from '@/app/lib/auth'\r\nimport { NotificationManager } from '@/app/lib/notifications'\r\nimport { logger } from '@/app/lib/logger'\r\nimport { formatErrorResponse } from '@/app/lib/api-errors'\r\nimport { withRateLimit } from '@/app/lib/rate-limit'\r\nimport { z } from 'zod'\r\n\r\n// Request schemas\r\nconst GetNotificationsSchema = z.object({\r\n  limit: z.number().min(1).max(100).optional().default(50),\r\n  offset: z.number().min(0).optional().default(0),\r\n  unread_only: z.boolean().optional().default(false),\r\n})\r\n\r\nconst MarkReadSchema = z.object({\r\n  notification_id: z.string().uuid(),\r\n})\r\n\r\nconst UpdatePreferencesSchema = z.object({\r\n  email_notifications: z.boolean().optional(),\r\n  in_app_notifications: z.boolean().optional(),\r\n  migration_updates: z.boolean().optional(),\r\n  maintenance_alerts: z.boolean().optional(),\r\n  feature_updates: z.boolean().optional(),\r\n  security_alerts: z.boolean().optional(),\r\n})\r\n\r\nexport async function GET(request: NextRequest) {\r\n  return withRateLimit(request, async () => {\r\n    try {\r\n      const session = await getServerSession(authOptions)\r\n      if (!session?.user) {\r\n        return formatErrorResponse('Unauthorized', 401)\r\n      }\r\n\r\n      const { searchParams } = new URL(request.url)\r\n      const query = {\r\n        limit: parseInt(searchParams.get('limit') || '50'),\r\n        offset: parseInt(searchParams.get('offset') || '0'),\r\n        unread_only: searchParams.get('unread_only') === 'true',\r\n      }\r\n\r\n      const validatedQuery = GetNotificationsSchema.parse(query)\r\n\r\n      const notificationManager = new NotificationManager(\r\n        process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n        process.env.SUPABASE_SERVICE_ROLE_KEY!\r\n      )\r\n\r\n      const notifications = await notificationManager.getUserNotifications(\r\n        session.user.id,\r\n        validatedQuery.limit,\r\n        validatedQuery.offset\r\n      )\r\n\r\n      // Filter unread only if requested\r\n      const filteredNotifications = validatedQuery.unread_only\r\n        ? notifications.filter(n => !n.read_at)\r\n        : notifications\r\n\r\n      return NextResponse.json({\r\n        success: true,\r\n        data: {\r\n          notifications: filteredNotifications,\r\n          count: filteredNotifications.length,\r\n          has_more: filteredNotifications.length === validatedQuery.limit,\r\n        }\r\n      })\r\n\r\n    } catch (error) {\r\n      logger.error('Failed to get notifications', { error })\r\n      return formatErrorResponse('Failed to get notifications', 500)\r\n    }\r\n  })\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  return withRateLimit(request, async () => {\r\n    try {\r\n      const session = await getServerSession(authOptions)\r\n      if (!session?.user) {\r\n        return formatErrorResponse('Unauthorized', 401)\r\n      }\r\n\r\n      const body = await request.json()\r\n      const { notification_id } = MarkReadSchema.parse(body)\r\n\r\n      const notificationManager = new NotificationManager(\r\n        process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n        process.env.SUPABASE_SERVICE_ROLE_KEY!\r\n      )\r\n\r\n      await notificationManager.markNotificationAsRead(notification_id)\r\n\r\n      return NextResponse.json({\r\n        success: true,\r\n        message: 'Notification marked as read'\r\n      })\r\n\r\n    } catch (error) {\r\n      logger.error('Failed to mark notification as read', { error })\r\n      return formatErrorResponse('Failed to mark notification as read', 500)\r\n    }\r\n  })\r\n}\r\n\r\nexport async function PUT(request: NextRequest) {\r\n  return withRateLimit(request, async () => {\r\n    try {\r\n      const session = await getServerSession(authOptions)\r\n      if (!session?.user) {\r\n        return formatErrorResponse('Unauthorized', 401)\r\n      }\r\n\r\n      const body = await request.json()\r\n      const preferences = UpdatePreferencesSchema.parse(body)\r\n\r\n      const notificationManager = new NotificationManager(\r\n        process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n        process.env.SUPABASE_SERVICE_ROLE_KEY!\r\n      )\r\n\r\n      await notificationManager.updateNotificationPreferences(\r\n        session.user.id,\r\n        preferences\r\n      )\r\n\r\n      return NextResponse.json({\r\n        success: true,\r\n        message: 'Notification preferences updated'\r\n      })\r\n\r\n    } catch (error) {\r\n      logger.error('Failed to update notification preferences', { error })\r\n      return formatErrorResponse('Failed to update notification preferences', 500)\r\n    }\r\n  })\r\n}\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;MA6BsBA,IAAA;IAAA;IAAAC,cAAA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","ignoreList":[]}