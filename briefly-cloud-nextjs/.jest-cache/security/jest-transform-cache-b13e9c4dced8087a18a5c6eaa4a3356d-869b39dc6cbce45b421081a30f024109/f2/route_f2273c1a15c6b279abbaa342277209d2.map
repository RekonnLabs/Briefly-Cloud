{"version":3,"names":["cov_14sr7jzjgx","actualCoverage","s","GET","req","f","supabase","_supabaseauth","createSupabaseServerClient","data","user","error","auth","getUser","b","_server","NextResponse","redirect","URL","url","stateParam","nextUrl","searchParams","get","stateCookie","_headers","cookies","value","delete","code","origin","redirect_uri","tokenRes","fetch","method","headers","body","URLSearchParams","client_id","process","env","GOOGLE_CLIENT_ID","client_secret","GOOGLE_CLIENT_SECRET","grant_type","tokenData","json","access_token","refresh_token","expires_in","scope","token_type","console","_tokenstore","storeEncryptedToken","userId","id","provider","accessToken","refreshToken","tokenType","expiresAt","Date","now"],"sources":["R:\\Apps\\Briefly_Cloud\\briefly-cloud-nextjs\\src\\app\\api\\storage\\google\\callback\\route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\r\nimport { createSupabaseServerClient } from '@/app/lib/auth/supabase-auth'\r\nimport { storeEncryptedToken } from '@/app/lib/oauth/token-store'\r\nimport { cookies } from 'next/headers'\r\n\r\nexport async function GET(req: NextRequest) {\r\n  try {\r\n    // Check if user is authenticated via Supabase Auth\r\n    const supabase = createSupabaseServerClient()\r\n    const { data: { user }, error } = await supabase.auth.getUser()\r\n    \r\n    if (error || !user) {\r\n      return NextResponse.redirect(new URL('/briefly/app/auth/signin', req.url))\r\n    }\r\n\r\n    // Validate CSRF state\r\n    const stateParam = req.nextUrl.searchParams.get('state')\r\n    const stateCookie = cookies().get('oauth_state_google')?.value\r\n    if (!stateParam || stateParam !== stateCookie) {\r\n      return NextResponse.redirect(new URL('/briefly/app/dashboard?tab=storage&error=state_mismatch', req.url))\r\n    }\r\n    \r\n    // Clear the state cookie\r\n    cookies().delete('oauth_state_google')\r\n\r\n    const code = req.nextUrl.searchParams.get('code')\r\n    if (!code) {\r\n      return NextResponse.redirect(new URL('/briefly/app/dashboard?tab=storage&error=no_code', req.url))\r\n    }\r\n\r\n    const origin = req.nextUrl.origin\r\n    const redirect_uri = `${origin}/api/storage/google/callback`\r\n\r\n    // Exchange code for tokens\r\n    const tokenRes = await fetch('https://oauth2.googleapis.com/token', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\r\n      body: new URLSearchParams({\r\n        code,\r\n        client_id: process.env.GOOGLE_CLIENT_ID!,\r\n        client_secret: process.env.GOOGLE_CLIENT_SECRET!,\r\n        redirect_uri,\r\n        grant_type: 'authorization_code',\r\n      }),\r\n    })\r\n\r\n    const tokenData = await tokenRes.json()\r\n    const { access_token, refresh_token, expires_in, scope, token_type } = tokenData\r\n\r\n    if (!access_token) {\r\n      console.error('Google OAuth token exchange failed:', tokenData)\r\n      return NextResponse.redirect(new URL('/briefly/app/dashboard?tab=storage&error=token_failed', req.url))\r\n    }\r\n\r\n    // Store encrypted tokens using secure token store\r\n    await storeEncryptedToken({\r\n      userId: user.id,\r\n      provider: 'google',\r\n      accessToken: access_token,\r\n      refreshToken: refresh_token,\r\n      scope,\r\n      tokenType: token_type,\r\n      expiresAt: new Date(Date.now() + (expires_in || 3600) * 1000),\r\n    })\r\n\r\n    // Redirect back to dashboard storage tab with success\r\n    return NextResponse.redirect(new URL('/briefly/app/dashboard?tab=storage&connected=google', req.url))\r\n\r\n  } catch (error) {\r\n    console.error('Google storage OAuth callback error:', error)\r\n    return NextResponse.redirect(new URL('/briefly/app/dashboard?tab=storage&error=callback_failed', req.url))\r\n  }\r\n}"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAMM;IAAAA,cAAA,YAAAA,CAAA;MAAA,OAAAC,cAAA;IAAA;EAAA;EAAA,OAAAA,cAAA;AAAA;AAAAD,cAAA;AAAAA,cAAA,GAAAE,CAAA;;;;;;+BADgB;;;;;;WAAAC,GAAA;;;;;kCALoB;;;kCACC;;;kCACP;;;kCACZ;AAEjB,eAAeA,IAAIC,GAAgB;EAAA;EAAAJ,cAAA,GAAAK,CAAA;EAAAL,cAAA,GAAAE,CAAA;EACxC,IAAI;IACF;IACA,MAAMI,QAAA;IAAA;IAAA,CAAAN,cAAA,GAAAE,CAAA,OAAW,IAAAK,aAAA,CAAAC,0BAA0B;IAC3C,MAAM;MAAEC,IAAA,EAAM;QAAEC;MAAI,CAAE;MAAEC;IAAK,CAAE;IAAA;IAAA,CAAAX,cAAA,GAAAE,CAAA,OAAG,MAAMI,QAAA,CAASM,IAAI,CAACC,OAAO;IAAA;IAAAb,cAAA,GAAAE,CAAA;IAE7D;IAAI;IAAA,CAAAF,cAAA,GAAAc,CAAA,UAAAH,KAAA;IAAA;IAAA,CAAAX,cAAA,GAAAc,CAAA,UAAS,CAACJ,IAAA,GAAM;MAAA;MAAAV,cAAA,GAAAc,CAAA;MAAAd,cAAA,GAAAE,CAAA;MAClB,OAAOa,OAAA,CAAAC,YAAY,CAACC,QAAQ,CAAC,IAAIC,GAAA,CAAI,4BAA4Bd,GAAA,CAAIe,GAAG;IAC1E;IAAA;IAAA;MAAAnB,cAAA,GAAAc,CAAA;IAAA;IAEA;IACA,MAAMM,UAAA;IAAA;IAAA,CAAApB,cAAA,GAAAE,CAAA,QAAaE,GAAA,CAAIiB,OAAO,CAACC,YAAY,CAACC,GAAG,CAAC;IAChD,MAAMC,WAAA;IAAA;IAAA,CAAAxB,cAAA,GAAAE,CAAA,QAAc,IAAAuB,QAAA,CAAAC,OAAO,IAAGH,GAAG,CAAC,uBAAuBI,KAAA;IAAA;IAAA3B,cAAA,GAAAE,CAAA;IACzD;IAAI;IAAA,CAAAF,cAAA,GAAAc,CAAA,WAACM,UAAA;IAAA;IAAA,CAAApB,cAAA,GAAAc,CAAA,UAAcM,UAAA,KAAeI,WAAA,GAAa;MAAA;MAAAxB,cAAA,GAAAc,CAAA;MAAAd,cAAA,GAAAE,CAAA;MAC7C,OAAOa,OAAA,CAAAC,YAAY,CAACC,QAAQ,CAAC,IAAIC,GAAA,CAAI,2DAA2Dd,GAAA,CAAIe,GAAG;IACzG;IAAA;IAAA;MAAAnB,cAAA,GAAAc,CAAA;IAAA;IAEA;IAAAd,cAAA,GAAAE,CAAA;IACA,IAAAuB,QAAA,CAAAC,OAAO,IAAGE,MAAM,CAAC;IAEjB,MAAMC,IAAA;IAAA;IAAA,CAAA7B,cAAA,GAAAE,CAAA,QAAOE,GAAA,CAAIiB,OAAO,CAACC,YAAY,CAACC,GAAG,CAAC;IAAA;IAAAvB,cAAA,GAAAE,CAAA;IAC1C,IAAI,CAAC2B,IAAA,EAAM;MAAA;MAAA7B,cAAA,GAAAc,CAAA;MAAAd,cAAA,GAAAE,CAAA;MACT,OAAOa,OAAA,CAAAC,YAAY,CAACC,QAAQ,CAAC,IAAIC,GAAA,CAAI,oDAAoDd,GAAA,CAAIe,GAAG;IAClG;IAAA;IAAA;MAAAnB,cAAA,GAAAc,CAAA;IAAA;IAEA,MAAMgB,MAAA;IAAA;IAAA,CAAA9B,cAAA,GAAAE,CAAA,QAASE,GAAA,CAAIiB,OAAO,CAACS,MAAM;IACjC,MAAMC,YAAA;IAAA;IAAA,CAAA/B,cAAA,GAAAE,CAAA,QAAe,GAAG4B,MAAA,8BAAoC;IAE5D;IACA,MAAME,QAAA;IAAA;IAAA,CAAAhC,cAAA,GAAAE,CAAA,QAAW,MAAM+B,KAAA,CAAM,uCAAuC;MAClEC,MAAA,EAAQ;MACRC,OAAA,EAAS;QAAE,gBAAgB;MAAoC;MAC/DC,IAAA,EAAM,IAAIC,eAAA,CAAgB;QACxBR,IAAA;QACAS,SAAA,EAAWC,OAAA,CAAQC,GAAG,CAACC,gBAAgB;QACvCC,aAAA,EAAeH,OAAA,CAAQC,GAAG,CAACG,oBAAoB;QAC/CZ,YAAA;QACAa,UAAA,EAAY;MACd;IACF;IAEA,MAAMC,SAAA;IAAA;IAAA,CAAA7C,cAAA,GAAAE,CAAA,QAAY,MAAM8B,QAAA,CAASc,IAAI;IACrC,MAAM;MAAEC,YAAY;MAAEC,aAAa;MAAEC,UAAU;MAAEC,KAAK;MAAEC;IAAU,CAAE;IAAA;IAAA,CAAAnD,cAAA,GAAAE,CAAA,QAAG2C,SAAA;IAAA;IAAA7C,cAAA,GAAAE,CAAA;IAEvE,IAAI,CAAC6C,YAAA,EAAc;MAAA;MAAA/C,cAAA,GAAAc,CAAA;MAAAd,cAAA,GAAAE,CAAA;MACjBkD,OAAA,CAAQzC,KAAK,CAAC,uCAAuCkC,SAAA;MAAA;MAAA7C,cAAA,GAAAE,CAAA;MACrD,OAAOa,OAAA,CAAAC,YAAY,CAACC,QAAQ,CAAC,IAAIC,GAAA,CAAI,yDAAyDd,GAAA,CAAIe,GAAG;IACvG;IAAA;IAAA;MAAAnB,cAAA,GAAAc,CAAA;IAAA;IAEA;IAAAd,cAAA,GAAAE,CAAA;IACA,MAAM,IAAAmD,WAAA,CAAAC,mBAAmB,EAAC;MACxBC,MAAA,EAAQ7C,IAAA,CAAK8C,EAAE;MACfC,QAAA,EAAU;MACVC,WAAA,EAAaX,YAAA;MACbY,YAAA,EAAcX,aAAA;MACdE,KAAA;MACAU,SAAA,EAAWT,UAAA;MACXU,SAAA,EAAW,IAAIC,IAAA,CAAKA,IAAA,CAAKC,GAAG,KAAK;MAAC;MAAA,CAAA/D,cAAA,GAAAc,CAAA,UAAAmC,UAAA;MAAA;MAAA,CAAAjD,cAAA,GAAAc,CAAA,UAAc,IAAG,KAAK;IAC1D;IAEA;IAAA;IAAAd,cAAA,GAAAE,CAAA;IACA,OAAOa,OAAA,CAAAC,YAAY,CAACC,QAAQ,CAAC,IAAIC,GAAA,CAAI,uDAAuDd,GAAA,CAAIe,GAAG;EAErG,EAAE,OAAOR,KAAA,EAAO;IAAA;IAAAX,cAAA,GAAAE,CAAA;IACdkD,OAAA,CAAQzC,KAAK,CAAC,wCAAwCA,KAAA;IAAA;IAAAX,cAAA,GAAAE,CAAA;IACtD,OAAOa,OAAA,CAAAC,YAAY,CAACC,QAAQ,CAAC,IAAIC,GAAA,CAAI,4DAA4Dd,GAAA,CAAIe,GAAG;EAC1G;AACF","ignoreList":[]}