{"version":3,"names":["cov_129ghamrr6","actualCoverage","s","POST","extractTextHandler","request","context","f","user","b","_apiutils","ApiResponse","unauthorized","formData","file","get","options","JSON","parse","badRequest","_documentextractor","isSupportedMimeType","type","maxSize","size","Math","round","buffer","Buffer","from","arrayBuffer","extractionResult","extractTextFromBuffer","name","chunks","createChunks","maxChunkSize","createTextChunks","text","Date","now","stats","getExtractionStats","_logger","logApiUsage","id","file_name","file_size","file_type","text_length","length","processing_time","metadata","processingTime","extractor_used","extractorUsed","chunk_count","success","extraction","warnings","file_info","error","console","Error","internalError","_apimiddleware","createProtectedApiHandler","rateLimit","_ratelimit","rateLimitConfigs","general","maxRequests","logging","enabled","includeBody"],"sources":["R:\\Apps\\Briefly_Cloud\\briefly-cloud-nextjs\\src\\app\\api\\extract\\route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\r\nimport { createProtectedApiHandler, ApiContext } from '@/app/lib/api-middleware'\r\nimport { ApiResponse } from '@/app/lib/api-utils'\r\nimport { rateLimitConfigs } from '@/app/lib/rate-limit'\r\n// import { createClient } from '@supabase/supabase-js'\r\nimport { logApiUsage } from '@/app/lib/logger'\r\nimport { \r\n  extractTextFromBuffer, \r\n  createTextChunks, \r\n  isSupportedMimeType,\r\n  getExtractionStats \r\n} from '@/app/lib/document-extractor'\r\n\r\n// POST /api/extract - Extract text from uploaded file\r\nasync function extractTextHandler(request: Request, context: ApiContext): Promise<NextResponse> {\r\n  const { user } = context\r\n  \r\n  if (!user) {\r\n    return ApiResponse.unauthorized('User not authenticated')\r\n  }\r\n  \r\n  try {\r\n    // Note: supabase client available if needed for future enhancements\r\n    // const supabase = createClient(\r\n    //   process.env.SUPABASE_URL!,\r\n    //   process.env.SUPABASE_ANON_KEY!\r\n    // )\r\n    \r\n    // Parse multipart form data\r\n    const formData = await request.formData()\r\n    const file = formData.get('file') as File\r\n    const options = formData.get('options') ? JSON.parse(formData.get('options') as string) : {}\r\n    \r\n    if (!file) {\r\n      return ApiResponse.badRequest('No file provided')\r\n    }\r\n    \r\n    // Validate file type\r\n    if (!isSupportedMimeType(file.type)) {\r\n      return ApiResponse.badRequest(\r\n        `File type ${file.type} is not supported for text extraction`\r\n      )\r\n    }\r\n    \r\n    // Check file size (limit to 50MB for extraction)\r\n    const maxSize = 50 * 1024 * 1024 // 50MB\r\n    if (file.size > maxSize) {\r\n      return ApiResponse.badRequest(\r\n        `File size ${Math.round(file.size / 1024 / 1024)}MB exceeds maximum allowed size of 50MB for text extraction`\r\n      )\r\n    }\r\n    \r\n    // Convert File to Buffer\r\n    const buffer = Buffer.from(await file.arrayBuffer())\r\n    \r\n    // Extract text\r\n    const extractionResult = await extractTextFromBuffer(buffer, file.type, file.name)\r\n    \r\n    // Create chunks if requested\r\n    let chunks = null\r\n    if (options.createChunks !== false) {\r\n      const maxChunkSize = options.maxChunkSize || 1000\r\n      chunks = createTextChunks(\r\n        extractionResult.text,\r\n        `temp_${Date.now()}`,\r\n        file.name,\r\n        file.type,\r\n        maxChunkSize\r\n      )\r\n    }\r\n    \r\n    // Get extraction statistics\r\n    const stats = getExtractionStats(extractionResult)\r\n    \r\n    // Log usage\r\n    logApiUsage(user.id, '/api/extract', 'text_extraction', {\r\n      file_name: file.name,\r\n      file_size: file.size,\r\n      file_type: file.type,\r\n      text_length: extractionResult.text.length,\r\n      processing_time: extractionResult.metadata.processingTime,\r\n      extractor_used: extractionResult.metadata.extractorUsed,\r\n      chunk_count: chunks?.length || 0,\r\n    })\r\n    \r\n    return ApiResponse.success({\r\n      extraction: {\r\n        text: extractionResult.text,\r\n        metadata: extractionResult.metadata,\r\n        warnings: extractionResult.warnings,\r\n        stats,\r\n      },\r\n      ...(chunks && { chunks }),\r\n      file_info: {\r\n        name: file.name,\r\n        size: file.size,\r\n        type: file.type,\r\n      },\r\n    }, 'Text extracted successfully')\r\n    \r\n  } catch (error) {\r\n    console.error('Text extraction handler error:', error)\r\n    \r\n    // Re-throw known errors\r\n    if (error instanceof Error && error.name === 'AppError') {\r\n      throw error\r\n    }\r\n    \r\n    return ApiResponse.internalError('Failed to extract text from document')\r\n  }\r\n}\r\n\r\n// Export handler with middleware\r\nexport const POST = createProtectedApiHandler(extractTextHandler, {\r\n  rateLimit: {\r\n    ...rateLimitConfigs.general,\r\n    maxRequests: 30, // More restrictive for processing-intensive operations\r\n  },\r\n  logging: {\r\n    enabled: true,\r\n    includeBody: false, // Don't log file content\r\n  },\r\n})"],"mappings":"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","ignoreList":[]}