{"version":3,"names":["GET","cov_ixb893f5j","f","s","POST","MigrationRequestSchema","_zod","z","object","action","enum","config","batchSize","number","min","max","optional","maxRetries","retryDelay","validateData","boolean","createBackup","dryRun","migrationStatusCache","Map","request","_ratelimit","withRateLimit","session","_nextauth","getServerSession","_auth","authOptions","user","b","_apierrors","formatErrorResponse","data","fetch","process","env","NEXTAUTH_URL","headers","Authorization","accessToken","then","res","json","is_admin","body","parse","supabaseUrl","NEXT_PUBLIC_SUPABASE_URL","supabaseKey","SUPABASE_SERVICE_ROLE_KEY","handleMigrationRun","handleMigrationValidate","handleMigrationStatus","error","_logger","logger","info","status","_migration","runMigration","set","id","_server","NextResponse","success","message","validation","validateMigrationData","valid","statuses","Array","from","values","migrations","count","length","latest"],"sources":["R:\\Apps\\Briefly_Cloud\\briefly-cloud-nextjs\\src\\app\\api\\migration\\route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\r\nimport { z } from 'zod'\r\nimport { runMigration, validateMigrationData, MigrationConfig } from '@/app/lib/migration'\r\nimport { getServerSession } from 'next-auth'\r\nimport { authOptions } from '@/app/lib/auth'\r\nimport { logger } from '@/app/lib/logger'\r\nimport { formatErrorResponse } from '@/app/lib/api-errors'\r\nimport { withRateLimit } from '@/app/lib/rate-limit'\r\n\r\n// Migration request schema\r\nconst MigrationRequestSchema = z.object({\r\n  action: z.enum(['run', 'validate', 'status']),\r\n  config: z.object({\r\n    batchSize: z.number().min(1).max(1000).optional(),\r\n    maxRetries: z.number().min(1).max(10).optional(),\r\n    retryDelay: z.number().min(100).max(10000).optional(),\r\n    validateData: z.boolean().optional(),\r\n    createBackup: z.boolean().optional(),\r\n    dryRun: z.boolean().optional(),\r\n  }).optional(),\r\n})\r\n\r\n// Migration status cache\r\nconst migrationStatusCache = new Map<string, any>()\r\n\r\nexport async function POST(request: NextRequest) {\r\n  return withRateLimit(request, async () => {\r\n    try {\r\n      // Check authentication and admin privileges\r\n      const session = await getServerSession(authOptions)\r\n      if (!session?.user) {\r\n        return formatErrorResponse('Unauthorized', 401)\r\n      }\r\n\r\n      // Only allow admin users to run migrations\r\n      const { data: user } = await fetch(`${process.env.NEXTAUTH_URL}/api/user/profile`, {\r\n        headers: { Authorization: `Bearer ${session.accessToken}` }\r\n      }).then(res => res.json())\r\n\r\n      if (!user?.is_admin) {\r\n        return formatErrorResponse('Admin privileges required', 403)\r\n      }\r\n\r\n      const body = await request.json()\r\n      const { action, config } = MigrationRequestSchema.parse(body)\r\n\r\n      const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!\r\n      const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY!\r\n\r\n      switch (action) {\r\n        case 'run':\r\n          return await handleMigrationRun(supabaseUrl, supabaseKey, config)\r\n        \r\n        case 'validate':\r\n          return await handleMigrationValidate(supabaseUrl, supabaseKey)\r\n        \r\n        case 'status':\r\n          return await handleMigrationStatus()\r\n        \r\n        default:\r\n          return formatErrorResponse('Invalid action', 400)\r\n      }\r\n\r\n    } catch (error) {\r\n      logger.error('Migration API error', { error })\r\n      return formatErrorResponse('Internal server error', 500)\r\n    }\r\n  })\r\n}\r\n\r\nasync function handleMigrationRun(\r\n  supabaseUrl: string, \r\n  supabaseKey: string, \r\n  config?: Partial<MigrationConfig>\r\n) {\r\n  try {\r\n    logger.info('Starting migration', { config })\r\n    \r\n    const status = await runMigration(supabaseUrl, supabaseKey, config)\r\n    \r\n    // Cache the migration status\r\n    migrationStatusCache.set(status.id, status)\r\n    \r\n    return NextResponse.json({\r\n      success: true,\r\n      data: status,\r\n      message: 'Migration started successfully'\r\n    })\r\n\r\n  } catch (error) {\r\n    logger.error('Migration run failed', { error })\r\n    return formatErrorResponse('Migration failed', 500, error.message)\r\n  }\r\n}\r\n\r\nasync function handleMigrationValidate(supabaseUrl: string, supabaseKey: string) {\r\n  try {\r\n    logger.info('Starting migration validation')\r\n    \r\n    const validation = await validateMigrationData(supabaseUrl, supabaseKey)\r\n    \r\n    return NextResponse.json({\r\n      success: true,\r\n      data: validation,\r\n      message: validation.valid ? 'Data validation passed' : 'Data validation failed'\r\n    })\r\n\r\n  } catch (error) {\r\n    logger.error('Migration validation failed', { error })\r\n    return formatErrorResponse('Validation failed', 500, error.message)\r\n  }\r\n}\r\n\r\nasync function handleMigrationStatus() {\r\n  try {\r\n    // Return all cached migration statuses\r\n    const statuses = Array.from(migrationStatusCache.values())\r\n    \r\n    return NextResponse.json({\r\n      success: true,\r\n      data: {\r\n        migrations: statuses,\r\n        count: statuses.length\r\n      }\r\n    })\r\n\r\n  } catch (error) {\r\n    logger.error('Migration status check failed', { error })\r\n    return formatErrorResponse('Status check failed', 500, error.message)\r\n  }\r\n}\r\n\r\nexport async function GET(request: NextRequest) {\r\n  return withRateLimit(request, async () => {\r\n    try {\r\n      // Check authentication\r\n      const session = await getServerSession(authOptions)\r\n      if (!session?.user) {\r\n        return formatErrorResponse('Unauthorized', 401)\r\n      }\r\n\r\n      // Get migration status\r\n      const statuses = Array.from(migrationStatusCache.values())\r\n      \r\n      return NextResponse.json({\r\n        success: true,\r\n        data: {\r\n          migrations: statuses,\r\n          count: statuses.length,\r\n          latest: statuses.length > 0 ? statuses[statuses.length - 1] : null\r\n        }\r\n      })\r\n\r\n    } catch (error) {\r\n      logger.error('Migration status API error', { error })\r\n      return formatErrorResponse('Internal server error', 500)\r\n    }\r\n  })\r\n}\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}