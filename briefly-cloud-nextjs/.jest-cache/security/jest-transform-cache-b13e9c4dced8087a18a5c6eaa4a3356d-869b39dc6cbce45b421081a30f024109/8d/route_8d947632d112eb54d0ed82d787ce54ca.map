{"version":3,"names":["POST","searchSchema","cov_vg8jvcuoy","s","_zod","z","object","query","string","min","max","limit","number","optional","default","threshold","fileIds","array","searchHandler","request","context","f","user","b","_apiutils","ApiResponse","unauthorized","body","json","catch","parsed","safeParse","success","badRequest","data","cacheKey","_cache","CACHE_KEYS","SEARCH_RESULTS","id","cachedResults","cacheManager","get","results","count","length","cached","_performance","withApiPerformanceMonitoring","_documentprocessor","searchDocuments","set","withPerformanceMonitoring","_apimiddleware","createProtectedApiHandler","rateLimit","_ratelimit","rateLimitConfigs","general","logging","enabled","includeBody"],"sources":["R:\\Apps\\Briefly_Cloud\\briefly-cloud-nextjs\\src\\app\\api\\search\\route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\r\nimport { createProtectedApiHandler, ApiContext } from '@/app/lib/api-middleware'\r\nimport { ApiResponse } from '@/app/lib/api-utils'\r\nimport { rateLimitConfigs } from '@/app/lib/rate-limit'\r\nimport { z } from 'zod'\r\nimport { searchDocuments } from '@/app/lib/vector/document-processor'\r\nimport { cacheManager, CACHE_KEYS, withCache } from '@/app/lib/cache'\r\nimport { withPerformanceMonitoring, withApiPerformanceMonitoring } from '@/app/lib/performance'\r\n\r\nconst searchSchema = z.object({\r\n  query: z.string().min(1).max(500),\r\n  limit: z.number().min(1).max(50).optional().default(10),\r\n  threshold: z.number().min(0).max(1).optional().default(0.7),\r\n  fileIds: z.array(z.string()).optional(),\r\n})\r\n\r\nasync function searchHandler(request: Request, context: ApiContext): Promise<NextResponse> {\r\n  const { user } = context\r\n  if (!user) return ApiResponse.unauthorized('User not authenticated')\r\n\r\n  const body = await request.json().catch(() => ({}))\r\n  const parsed = searchSchema.safeParse(body)\r\n  if (!parsed.success) return ApiResponse.badRequest('Invalid request data')\r\n\r\n  const { query, limit, threshold, fileIds } = parsed.data\r\n\r\n  // Create cache key for this search\r\n  const cacheKey = CACHE_KEYS.SEARCH_RESULTS(query, user.id)\r\n  \r\n  // Try to get cached results first\r\n  const cachedResults = cacheManager.get(cacheKey)\r\n  if (cachedResults) {\r\n    return ApiResponse.success({\r\n      query,\r\n      results: cachedResults,\r\n      count: cachedResults.length,\r\n      cached: true,\r\n    })\r\n  }\r\n\r\n  // Perform search with performance monitoring\r\n  const results = await withApiPerformanceMonitoring(() =>\r\n    searchDocuments(user.id, query, {\r\n      limit,\r\n      threshold,\r\n      fileIds,\r\n    })\r\n  )\r\n\r\n  // Cache results for 5 minutes\r\n  cacheManager.set(cacheKey, results, 1000 * 60 * 5)\r\n\r\n  return ApiResponse.success({\r\n    query,\r\n    results,\r\n    count: results.length,\r\n    cached: false,\r\n  })\r\n}\r\n\r\nexport const POST = withPerformanceMonitoring(\r\n  createProtectedApiHandler(searchHandler, {\r\n    rateLimit: rateLimitConfigs.general,\r\n    logging: { enabled: true, includeBody: true },\r\n  })\r\n)\r\n\r\n\r\n\r\n"],"mappings":"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","ignoreList":[]}