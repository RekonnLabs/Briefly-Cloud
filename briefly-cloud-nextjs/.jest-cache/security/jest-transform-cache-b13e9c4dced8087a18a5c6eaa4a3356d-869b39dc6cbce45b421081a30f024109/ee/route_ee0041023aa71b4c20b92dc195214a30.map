{"version":3,"names":["GET","cov_1g51b5s67e","f","s","POST","RollbackRequestSchema","_zod","z","object","backupId","string","min","confirm","boolean","refine","val","message","request","_ratelimit","withRateLimit","session","_nextauth","getServerSession","_auth","authOptions","user","b","_apierrors","formatErrorResponse","data","fetch","process","env","NEXTAUTH_URL","headers","Authorization","accessToken","then","res","json","is_admin","body","parse","supabaseUrl","NEXT_PUBLIC_SUPABASE_URL","supabaseKey","SUPABASE_SERVICE_ROLE_KEY","_logger","logger","warn","userId","id","success","_migration","rollbackMigration","info","_server","NextResponse","error","cacheManager","Promise","resolve","_interop_require_wildcard","require","availableBackups","cacheKeys","Array","from","keys","key","startsWith","replace","push","count","length"],"sources":["R:\\Apps\\Briefly_Cloud\\briefly-cloud-nextjs\\src\\app\\api\\migration\\rollback\\route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\r\nimport { z } from 'zod'\r\nimport { rollbackMigration } from '@/app/lib/migration'\r\nimport { getServerSession } from 'next-auth'\r\nimport { authOptions } from '@/app/lib/auth'\r\nimport { logger } from '@/app/lib/logger'\r\nimport { formatErrorResponse } from '@/app/lib/api-errors'\r\nimport { withRateLimit } from '@/app/lib/rate-limit'\r\n\r\n// Rollback request schema\r\nconst RollbackRequestSchema = z.object({\r\n  backupId: z.string().min(1),\r\n  confirm: z.boolean().refine(val => val === true, {\r\n    message: 'Must explicitly confirm rollback operation'\r\n  }),\r\n})\r\n\r\nexport async function POST(request: NextRequest) {\r\n  return withRateLimit(request, async () => {\r\n    try {\r\n      // Check authentication and admin privileges\r\n      const session = await getServerSession(authOptions)\r\n      if (!session?.user) {\r\n        return formatErrorResponse('Unauthorized', 401)\r\n      }\r\n\r\n      // Only allow admin users to run rollbacks\r\n      const { data: user } = await fetch(`${process.env.NEXTAUTH_URL}/api/user/profile`, {\r\n        headers: { Authorization: `Bearer ${session.accessToken}` }\r\n      }).then(res => res.json())\r\n\r\n      if (!user?.is_admin) {\r\n        return formatErrorResponse('Admin privileges required', 403)\r\n      }\r\n\r\n      const body = await request.json()\r\n      const { backupId, confirm } = RollbackRequestSchema.parse(body)\r\n\r\n      if (!confirm) {\r\n        return formatErrorResponse('Rollback must be explicitly confirmed', 400)\r\n      }\r\n\r\n      const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!\r\n      const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY!\r\n\r\n      logger.warn('Starting migration rollback', { backupId, userId: session.user.id })\r\n      \r\n      const success = await rollbackMigration(supabaseUrl, supabaseKey, backupId)\r\n      \r\n      if (success) {\r\n        logger.info('Migration rollback completed successfully', { backupId })\r\n        return NextResponse.json({\r\n          success: true,\r\n          data: { backupId },\r\n          message: 'Migration rollback completed successfully'\r\n        })\r\n      } else {\r\n        logger.error('Migration rollback failed', { backupId })\r\n        return formatErrorResponse('Migration rollback failed', 500)\r\n      }\r\n\r\n    } catch (error) {\r\n      logger.error('Migration rollback API error', { error })\r\n      return formatErrorResponse('Internal server error', 500)\r\n    }\r\n  })\r\n}\r\n\r\nexport async function GET(request: NextRequest) {\r\n  return withRateLimit(request, async () => {\r\n    try {\r\n      // Check authentication\r\n      const session = await getServerSession(authOptions)\r\n      if (!session?.user) {\r\n        return formatErrorResponse('Unauthorized', 401)\r\n      }\r\n\r\n      // Get available backups from cache\r\n      const { cacheManager } = await import('@/app/lib/cache')\r\n      const availableBackups: string[] = []\r\n      \r\n      // This is a simplified approach - in production you'd want to store backup metadata\r\n      // in a database table for better management\r\n      const cacheKeys = Array.from(cacheManager['cache'].keys())\r\n      for (const key of cacheKeys) {\r\n        if (key.startsWith('backup:')) {\r\n          const backupId = key.replace('backup:', '')\r\n          availableBackups.push(backupId)\r\n        }\r\n      }\r\n\r\n      return NextResponse.json({\r\n        success: true,\r\n        data: {\r\n          availableBackups,\r\n          count: availableBackups.length\r\n        }\r\n      })\r\n\r\n    } catch (error) {\r\n      logger.error('Migration rollback status API error', { error })\r\n      return formatErrorResponse('Internal server error', 500)\r\n    }\r\n  })\r\n}\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}