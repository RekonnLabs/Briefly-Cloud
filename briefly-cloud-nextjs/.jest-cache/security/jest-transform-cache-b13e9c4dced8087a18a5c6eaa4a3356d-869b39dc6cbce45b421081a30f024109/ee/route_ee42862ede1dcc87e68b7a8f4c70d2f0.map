{"version":3,"names":["POST","schema","cov_okln92d40","s","importGoogleFileHandler","request","context","f","user","b","_apiutils","ApiResponse","unauthorized","body","json","catch","fileId","badRequest","data","token","_supabase","supabaseAdmin","from","select","eq","id","single","access_token","oauth2Client","_googleapis","google","auth","OAuth2","setCredentials","refresh_token","drive","version","meta","files","get","fields","res","alt","responseType","buffer","Buffer","created","insert","user_id","name","path","size","Number","byteLength","mime_type","mimeType","source","external_id","external_url","processed","processing_status","metadata","provider","extraction","_documentextractor","extractTextFromBuffer","processDocument","Promise","resolve","then","_interop_require_wildcard","require","text","externalId","importedAt","Date","toISOString","success","file_id","_apimiddleware","createProtectedApiHandler","rateLimit","_ratelimit","rateLimitConfigs","embedding","logging","enabled","includeBody"],"sources":["R:\\Apps\\Briefly_Cloud\\briefly-cloud-nextjs\\src\\app\\api\\storage\\google\\import\\route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\r\nimport { createProtectedApiHandler, ApiContext } from '@/app/lib/api-middleware'\r\nimport { ApiResponse } from '@/app/lib/api-utils'\r\nimport { rateLimitConfigs } from '@/app/lib/rate-limit'\r\nimport { google } from 'googleapis'\r\nimport { supabaseAdmin } from '@/app/lib/supabase'\r\nimport { extractTextFromBuffer } from '@/app/lib/document-extractor'\r\nimport { createTextChunks } from '@/app/lib/document-extractor'\r\nimport { storeDocumentChunks } from '@/app/lib/document-chunker'\r\nimport { createEmbeddingsService } from '@/app/lib/embeddings'\r\nimport { storeDocumentVectors } from '@/app/lib/vector-storage'\r\n\r\nconst schema = {\r\n  // Expect { fileId: string }\r\n}\r\n\r\nasync function importGoogleFileHandler(request: Request, context: ApiContext): Promise<NextResponse> {\r\n  const { user } = context\r\n  if (!user) return ApiResponse.unauthorized('User not authenticated')\r\n  const body = await request.json().catch(() => ({})) as { fileId?: string }\r\n  if (!body.fileId) return ApiResponse.badRequest('fileId is required')\r\n\r\n  const { data: token } = await supabaseAdmin\r\n    .from('oauth_tokens')\r\n    .select('*')\r\n    .eq('user_id', user.id)\r\n    .eq('provider', 'google')\r\n    .single()\r\n\r\n  if (!token?.access_token) return ApiResponse.badRequest('Google account not connected')\r\n\r\n  const oauth2Client = new google.auth.OAuth2()\r\n  oauth2Client.setCredentials({ access_token: token.access_token, refresh_token: token.refresh_token })\r\n  const drive = google.drive({ version: 'v3', auth: oauth2Client })\r\n\r\n  // Get file metadata\r\n  const meta = await drive.files.get({ fileId: body.fileId, fields: 'id, name, mimeType, size' })\r\n  // Download file content\r\n  const res = await drive.files.get({ fileId: body.fileId, alt: 'media' }, { responseType: 'arraybuffer' })\r\n  const buffer = Buffer.from(res.data as ArrayBuffer)\r\n\r\n  // Create file metadata row\r\n  const { data: created } = await supabaseAdmin\r\n    .from('file_metadata')\r\n    .insert({\r\n      user_id: user.id,\r\n      name: meta.data.name,\r\n      path: `google:${meta.data.id}`,\r\n      size: Number(meta.data.size || buffer.byteLength),\r\n      mime_type: meta.data.mimeType,\r\n      source: 'google',\r\n      external_id: meta.data.id,\r\n      external_url: `https://drive.google.com/file/d/${meta.data.id}/view`,\r\n      processed: false,\r\n      processing_status: 'pending',\r\n      metadata: { provider: 'google' },\r\n    })\r\n    .select()\r\n    .single()\r\n\r\n  const fileId = created.id\r\n  // Extract text and process with new vector pipeline\r\n  const extraction = await extractTextFromBuffer(buffer, meta.data.mimeType!, meta.data.name!)\r\n  \r\n  const { processDocument } = await import('@/app/lib/vector/document-processor')\r\n  await processDocument(user.id, fileId, meta.data.name!, extraction.text, {\r\n    source: 'google_drive',\r\n    mimeType: meta.data.mimeType,\r\n    externalId: body.fileId,\r\n    importedAt: new Date().toISOString()\r\n  })\r\n\r\n  return ApiResponse.success({ file_id: fileId, name: meta.data.name })\r\n}\r\n\r\nexport const POST = createProtectedApiHandler(importGoogleFileHandler, {\r\n  rateLimit: rateLimitConfigs.embedding,\r\n  logging: { enabled: true, includeBody: true },\r\n})\r\n\r\n\r\n\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}