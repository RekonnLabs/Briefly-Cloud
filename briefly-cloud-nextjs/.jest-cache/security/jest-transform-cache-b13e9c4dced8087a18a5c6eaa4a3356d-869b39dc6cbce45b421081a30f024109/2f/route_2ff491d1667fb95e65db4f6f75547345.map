{"version":3,"names":["POST","batchExtractionSchema","cov_1lthomjlde","s","_zod","z","object","file_ids","array","string","min","max","options","createChunks","boolean","optional","default","maxChunkSize","number","saveToDatabase","forceReprocess","batchExtractionHandler","request","context","f","user","b","_apiutils","ApiResponse","unauthorized","body","json","validation","safeParse","success","badRequest","data","supabase","_supabase","supabaseAdmin","files","error","filesError","from","select","eq","id","in","console","internalError","length","notFound","results","processed","skipped","failed","summary","total_requested","total_found","total_processed","total_skipped","total_failed","total_processing_time","file","_documentextractor","isSupportedMimeType","mime_type","push","file_id","file_name","name","reason","existingChunks","order","ascending","from_cache","chunk_count","text_length","metadata","character_count","processing_time","fileBuffer","source","path","fileData","downloadError","storage","download","Buffer","arrayBuffer","extractionResult","extractTextFromBuffer","chunks","createTextChunks","text","delete","chunkData","map","chunk","user_id","chunk_index","chunkIndex","content","insert","update","processing_status","extractor_used","extractorUsed","processingTime","word_count","wordCount","characterCount","page_count","pageCount","warnings","extracted_at","extractedAt","updated_at","Date","toISOString","dbError","stats","getExtractionStats","Error","message","_logger","logApiUsage","requested_count","processed_count","skipped_count","failed_count","_apimiddleware","createProtectedApiHandler","rateLimit","_ratelimit","rateLimitConfigs","embedding","maxRequests","logging","enabled","includeBody"],"sources":["R:\\Apps\\Briefly_Cloud\\briefly-cloud-nextjs\\src\\app\\api\\extract\\batch\\route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\r\nimport { createProtectedApiHandler, ApiContext } from '@/app/lib/api-middleware'\r\nimport { ApiResponse } from '@/app/lib/api-utils'\r\nimport { rateLimitConfigs } from '@/app/lib/rate-limit'\r\nimport { supabaseAdmin } from '@/app/lib/supabase'\r\nimport { logApiUsage } from '@/app/lib/logger'\r\nimport { \r\n  extractTextFromBuffer, \r\n  createTextChunks, \r\n  isSupportedMimeType,\r\n  getExtractionStats \r\n} from '@/app/lib/document-extractor'\r\nimport { z } from 'zod'\r\n\r\n// Validation schema\r\nconst batchExtractionSchema = z.object({\r\n  file_ids: z.array(z.string()).min(1).max(10), // Limit to 10 files at once\r\n  options: z.object({\r\n    createChunks: z.boolean().optional().default(true),\r\n    maxChunkSize: z.number().min(100).max(5000).optional().default(1000),\r\n    saveToDatabase: z.boolean().optional().default(true),\r\n    forceReprocess: z.boolean().optional().default(false),\r\n  }).optional().default({}),\r\n})\r\n\r\n// POST /api/extract/batch - Extract text from multiple files\r\nasync function batchExtractionHandler(request: Request, context: ApiContext): Promise<NextResponse> {\r\n  const { user } = context\r\n  \r\n  if (!user) {\r\n    return ApiResponse.unauthorized('User not authenticated')\r\n  }\r\n  \r\n  try {\r\n    const body = await request.json()\r\n    const validation = batchExtractionSchema.safeParse(body)\r\n    \r\n    if (!validation.success) {\r\n      return ApiResponse.badRequest('Invalid request data')\r\n    }\r\n    \r\n    const { file_ids, options } = validation.data\r\n    \r\n    const supabase = supabaseAdmin\r\n    \r\n    // Get files metadata\r\n    const { data: files, error: filesError } = await supabase\r\n      .from('file_metadata')\r\n      .select('*')\r\n      .eq('user_id', user.id)\r\n      .in('id', file_ids)\r\n    \r\n    if (filesError) {\r\n      console.error('Files fetch error:', filesError)\r\n      return ApiResponse.internalError('Failed to fetch files')\r\n    }\r\n    \r\n    if (!files || files.length === 0) {\r\n      return ApiResponse.notFound('No files found')\r\n    }\r\n    \r\n    const results = {\r\n      processed: [] as any[],\r\n      skipped: [] as any[],\r\n      failed: [] as any[],\r\n      summary: {\r\n        total_requested: file_ids.length,\r\n        total_found: files.length,\r\n        total_processed: 0,\r\n        total_skipped: 0,\r\n        total_failed: 0,\r\n        total_processing_time: 0,\r\n      },\r\n    }\r\n    \r\n    // Process each file\r\n    for (const file of files) {\r\n      try {\r\n        // Check if file type is supported\r\n        if (!isSupportedMimeType(file.mime_type)) {\r\n          results.skipped.push({\r\n            file_id: file.id,\r\n            file_name: file.name,\r\n            reason: `File type ${file.mime_type} is not supported for text extraction`,\r\n          })\r\n          continue\r\n        }\r\n        \r\n        // Check if already processed and not forcing reprocess\r\n        if (file.processed && !options.forceReprocess) {\r\n          // Get existing chunks\r\n          const { data: existingChunks } = await supabase\r\n            .from('document_chunks')\r\n            .select('*')\r\n            .eq('file_id', file.id)\r\n            .order('chunk_index', { ascending: true })\r\n          \r\n          if (existingChunks && existingChunks.length > 0) {\r\n            results.processed.push({\r\n              file_id: file.id,\r\n              file_name: file.name,\r\n              from_cache: true,\r\n              chunk_count: existingChunks.length,\r\n              text_length: file.metadata?.character_count || 0,\r\n              processing_time: 0,\r\n            })\r\n            continue\r\n          }\r\n        }\r\n        \r\n        // Download file\r\n        let fileBuffer: Buffer\r\n        \r\n        if (file.source === 'upload' && file.path) {\r\n          const { data: fileData, error: downloadError } = await supabase.storage\r\n            .from('documents')\r\n            .download(file.path)\r\n          \r\n          if (downloadError || !fileData) {\r\n            results.failed.push({\r\n              file_id: file.id,\r\n              file_name: file.name,\r\n              error: 'Failed to download file',\r\n            })\r\n            continue\r\n          }\r\n          \r\n          fileBuffer = Buffer.from(await fileData.arrayBuffer())\r\n        } else {\r\n          results.skipped.push({\r\n            file_id: file.id,\r\n            file_name: file.name,\r\n            reason: 'Cloud storage files not yet supported for batch extraction',\r\n          })\r\n          continue\r\n        }\r\n        \r\n        // Extract text\r\n        const extractionResult = await extractTextFromBuffer(fileBuffer, file.mime_type, file.name)\r\n        \r\n        // Create chunks\r\n        let chunks = null\r\n        if (options.createChunks) {\r\n          chunks = createTextChunks(\r\n            extractionResult.text,\r\n            file.id,\r\n            file.name,\r\n            file.mime_type,\r\n            options.maxChunkSize\r\n          )\r\n        }\r\n        \r\n        // Save to database\r\n        if (options.saveToDatabase && chunks) {\r\n          try {\r\n            // Delete existing chunks\r\n            await supabase\r\n              .from('document_chunks')\r\n              .delete()\r\n              .eq('file_id', file.id)\r\n            \r\n            // Insert new chunks\r\n            const chunkData = chunks.map(chunk => ({\r\n              file_id: file.id,\r\n              user_id: user.id,\r\n              chunk_index: chunk.chunkIndex,\r\n              content: chunk.content,\r\n              metadata: chunk.metadata,\r\n            }))\r\n            \r\n            await supabase\r\n              .from('document_chunks')\r\n              .insert(chunkData)\r\n            \r\n            // Update file metadata\r\n            await supabase\r\n              .from('file_metadata')\r\n              .update({\r\n                processed: true,\r\n                processing_status: 'completed',\r\n                metadata: {\r\n                  ...file.metadata,\r\n                  chunk_count: chunks.length,\r\n                  extractor_used: extractionResult.metadata.extractorUsed,\r\n                  processing_time: extractionResult.metadata.processingTime,\r\n                  word_count: extractionResult.metadata.wordCount,\r\n                  character_count: extractionResult.metadata.characterCount,\r\n                  page_count: extractionResult.metadata.pageCount,\r\n                  warnings: extractionResult.warnings,\r\n                  extracted_at: extractionResult.metadata.extractedAt,\r\n                },\r\n                updated_at: new Date().toISOString(),\r\n              })\r\n              .eq('id', file.id)\r\n            \r\n          } catch (dbError) {\r\n            console.error(`Database save error for file ${file.id}:`, dbError)\r\n            // Continue without failing the extraction\r\n          }\r\n        }\r\n        \r\n        // Add to results\r\n        const stats = getExtractionStats(extractionResult)\r\n        results.processed.push({\r\n          file_id: file.id,\r\n          file_name: file.name,\r\n          from_cache: false,\r\n          chunk_count: chunks?.length || 0,\r\n          text_length: extractionResult.text.length,\r\n          processing_time: extractionResult.metadata.processingTime,\r\n          word_count: extractionResult.metadata.wordCount,\r\n          page_count: extractionResult.metadata.pageCount,\r\n          warnings: extractionResult.warnings,\r\n          stats,\r\n        })\r\n        \r\n        results.summary.total_processing_time += extractionResult.metadata.processingTime\r\n        \r\n      } catch (error) {\r\n        console.error(`Error processing file ${file.id}:`, error)\r\n        results.failed.push({\r\n          file_id: file.id,\r\n          file_name: file.name,\r\n          error: error instanceof Error ? error.message : 'Unknown error',\r\n        })\r\n      }\r\n    }\r\n    \r\n    // Update summary\r\n    results.summary.total_processed = results.processed.length\r\n    results.summary.total_skipped = results.skipped.length\r\n    results.summary.total_failed = results.failed.length\r\n    \r\n    // Log usage\r\n    logApiUsage(user.id, '/api/extract/batch', 'batch_text_extraction', {\r\n      requested_count: file_ids.length,\r\n      processed_count: results.summary.total_processed,\r\n      skipped_count: results.summary.total_skipped,\r\n      failed_count: results.summary.total_failed,\r\n      total_processing_time: results.summary.total_processing_time,\r\n      options,\r\n    })\r\n    \r\n    return ApiResponse.success(results, \r\n      `Batch extraction completed: ${results.summary.total_processed} processed, ${results.summary.total_skipped} skipped, ${results.summary.total_failed} failed`\r\n    )\r\n    \r\n  } catch (error) {\r\n    console.error('Batch extraction handler error:', error)\r\n    return ApiResponse.internalError('Failed to process batch extraction')\r\n  }\r\n}\r\n\r\n// Export handler with middleware\r\nexport const POST = createProtectedApiHandler(batchExtractionHandler, {\r\n  rateLimit: {\r\n    ...rateLimitConfigs.embedding, // Use embedding rate limits (more restrictive)\r\n    maxRequests: 5, // Very restrictive for batch operations\r\n  },\r\n  logging: {\r\n    enabled: true,\r\n    includeBody: true,\r\n  },\r\n})"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}