{"version":3,"names":["cov_2khigp5jch","actualCoverage","s","GET","req","f","supabase","_supabaseauth","createSupabaseServerClient","data","user","error","auth","getUser","b","_server","NextResponse","redirect","URL","url","stateParam","nextUrl","searchParams","get","stateCookie","_headers","cookies","value","delete","code","origin","redirect_uri","tenant","process","env","AZURE_AD_TENANT_ID","tokenRes","fetch","method","headers","body","URLSearchParams","client_id","AZURE_AD_CLIENT_ID","client_secret","AZURE_AD_CLIENT_SECRET","grant_type","tokenData","json","access_token","refresh_token","expires_in","scope","token_type","console","_tokenstore","storeEncryptedToken","userId","id","provider","accessToken","refreshToken","tokenType","expiresAt","Date","now"],"sources":["R:\\Apps\\Briefly_Cloud\\briefly-cloud-nextjs\\src\\app\\api\\storage\\microsoft\\callback\\route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\r\nimport { createSupabaseServerClient } from '@/app/lib/auth/supabase-auth'\r\nimport { storeEncryptedToken } from '@/app/lib/oauth/token-store'\r\nimport { cookies } from 'next/headers'\r\n\r\nexport async function GET(req: NextRequest) {\r\n  try {\r\n    // Check if user is authenticated via Supabase Auth\r\n    const supabase = createSupabaseServerClient()\r\n    const { data: { user }, error } = await supabase.auth.getUser()\r\n    \r\n    if (error || !user) {\r\n      return NextResponse.redirect(new URL('/briefly/app/auth/signin', req.url))\r\n    }\r\n\r\n    // Validate CSRF state\r\n    const stateParam = req.nextUrl.searchParams.get('state')\r\n    const stateCookie = cookies().get('oauth_state_microsoft')?.value\r\n    if (!stateParam || stateParam !== stateCookie) {\r\n      return NextResponse.redirect(new URL('/briefly/app/dashboard?tab=storage&error=state_mismatch', req.url))\r\n    }\r\n    \r\n    // Clear the state cookie\r\n    cookies().delete('oauth_state_microsoft')\r\n\r\n    const code = req.nextUrl.searchParams.get('code')\r\n    if (!code) {\r\n      return NextResponse.redirect(new URL('/briefly/app/dashboard?tab=storage&error=no_code', req.url))\r\n    }\r\n\r\n    const origin = req.nextUrl.origin\r\n    const redirect_uri = `${origin}/api/storage/microsoft/callback`\r\n    const tenant = process.env.AZURE_AD_TENANT_ID || 'common'\r\n\r\n    // Exchange code for tokens\r\n    const tokenRes = await fetch(`https://login.microsoftonline.com/${tenant}/oauth2/v2.0/token`, {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\r\n      body: new URLSearchParams({\r\n        client_id: process.env.AZURE_AD_CLIENT_ID!,\r\n        client_secret: process.env.AZURE_AD_CLIENT_SECRET!,\r\n        grant_type: 'authorization_code',\r\n        code,\r\n        redirect_uri,\r\n      }),\r\n    })\r\n\r\n    const tokenData = await tokenRes.json()\r\n    const { access_token, refresh_token, expires_in, scope, token_type } = tokenData\r\n\r\n    if (!access_token) {\r\n      console.error('Microsoft OAuth token exchange failed:', tokenData)\r\n      return NextResponse.redirect(new URL('/briefly/app/dashboard?tab=storage&error=token_failed', req.url))\r\n    }\r\n\r\n    // Store encrypted tokens using secure token store\r\n    await storeEncryptedToken({\r\n      userId: user.id,\r\n      provider: 'microsoft',\r\n      accessToken: access_token,\r\n      refreshToken: refresh_token,\r\n      scope,\r\n      tokenType: token_type,\r\n      expiresAt: new Date(Date.now() + (expires_in || 3600) * 1000),\r\n    })\r\n\r\n    // Redirect back to dashboard storage tab with success\r\n    return NextResponse.redirect(new URL('/briefly/app/dashboard?tab=storage&connected=microsoft', req.url))\r\n\r\n  } catch (error) {\r\n    console.error('Microsoft storage OAuth callback error:', error)\r\n    return NextResponse.redirect(new URL('/briefly/app/dashboard?tab=storage&error=callback_failed', req.url))\r\n  }\r\n}"],"mappings":"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","ignoreList":[]}