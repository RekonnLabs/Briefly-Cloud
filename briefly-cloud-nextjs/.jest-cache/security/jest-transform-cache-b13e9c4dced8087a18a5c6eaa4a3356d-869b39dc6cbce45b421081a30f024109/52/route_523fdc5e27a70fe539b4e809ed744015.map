{"version":3,"names":["GET","cov_22vaupftln","f","s","POST","PUT","CreateTicketSchema","_zod","z","object","subject","string","min","max","description","priority","enum","category","UpdateTicketSchema","ticket_id","uuid","status","optional","response","request","_ratelimit","withRateLimit","session","_nextauth","getServerSession","_auth","authOptions","user","b","_apierrors","formatErrorResponse","body","json","parse","ticket","id","crypto","randomUUID","user_id","created_at","Date","toISOString","updated_at","_logger","logger","info","ticketId","userId","sendSupportNotification","_server","NextResponse","success","data","message","error","searchParams","URL","url","limit","parseInt","get","offset","tickets","getUserTickets","count","length","updatedTicket","updateTicket","updates"],"sources":["R:\\Apps\\Briefly_Cloud\\briefly-cloud-nextjs\\src\\app\\api\\support\\ticket\\route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\r\nimport { getServerSession } from 'next-auth'\r\nimport { authOptions } from '@/app/lib/auth'\r\nimport { logger } from '@/app/lib/logger'\r\nimport { formatErrorResponse } from '@/app/lib/api-errors'\r\nimport { withRateLimit } from '@/app/lib/rate-limit'\r\nimport { z } from 'zod'\r\n\r\n// Support ticket schemas\r\nconst CreateTicketSchema = z.object({\r\n  subject: z.string().min(1).max(200),\r\n  description: z.string().min(10).max(2000),\r\n  priority: z.enum(['low', 'medium', 'high', 'critical']),\r\n  category: z.enum(['migration', 'technical', 'billing', 'feature', 'other']),\r\n})\r\n\r\nconst UpdateTicketSchema = z.object({\r\n  ticket_id: z.string().uuid(),\r\n  status: z.enum(['open', 'in_progress', 'resolved', 'closed']).optional(),\r\n  response: z.string().min(1).max(1000).optional(),\r\n})\r\n\r\nexport async function POST(request: NextRequest) {\r\n  return withRateLimit(request, async () => {\r\n    try {\r\n      const session = await getServerSession(authOptions)\r\n      if (!session?.user) {\r\n        return formatErrorResponse('Unauthorized', 401)\r\n      }\r\n\r\n      const body = await request.json()\r\n      const { subject, description, priority, category } = CreateTicketSchema.parse(body)\r\n\r\n      // Create support ticket in database\r\n      const ticket = {\r\n        id: crypto.randomUUID(),\r\n        user_id: session.user.id,\r\n        subject,\r\n        description,\r\n        priority,\r\n        category,\r\n        status: 'open',\r\n        created_at: new Date().toISOString(),\r\n        updated_at: new Date().toISOString(),\r\n      }\r\n\r\n      // Store ticket in database (this would be implemented with your database)\r\n      // For now, we'll log it and return success\r\n      logger.info('Support ticket created', {\r\n        ticketId: ticket.id,\r\n        userId: session.user.id,\r\n        subject,\r\n        priority,\r\n        category,\r\n      })\r\n\r\n      // Send notification to support team (optional)\r\n      await sendSupportNotification(ticket)\r\n\r\n      return NextResponse.json({\r\n        success: true,\r\n        data: {\r\n          ticket_id: ticket.id,\r\n          message: 'Support ticket submitted successfully'\r\n        }\r\n      })\r\n\r\n    } catch (error) {\r\n      logger.error('Failed to create support ticket', { error })\r\n      return formatErrorResponse('Failed to submit ticket', 500)\r\n    }\r\n  })\r\n}\r\n\r\nexport async function GET(request: NextRequest) {\r\n  return withRateLimit(request, async () => {\r\n    try {\r\n      const session = await getServerSession(authOptions)\r\n      if (!session?.user) {\r\n        return formatErrorResponse('Unauthorized', 401)\r\n      }\r\n\r\n      const { searchParams } = new URL(request.url)\r\n      const limit = parseInt(searchParams.get('limit') || '10')\r\n      const offset = parseInt(searchParams.get('offset') || '0')\r\n\r\n      // Get user's support tickets from database\r\n      // This would be implemented with your database\r\n      const tickets = await getUserTickets(session.user.id, limit, offset)\r\n\r\n      return NextResponse.json({\r\n        success: true,\r\n        data: {\r\n          tickets,\r\n          count: tickets.length,\r\n        }\r\n      })\r\n\r\n    } catch (error) {\r\n      logger.error('Failed to get support tickets', { error })\r\n      return formatErrorResponse('Failed to get tickets', 500)\r\n    }\r\n  })\r\n}\r\n\r\nexport async function PUT(request: NextRequest) {\r\n  return withRateLimit(request, async () => {\r\n    try {\r\n      const session = await getServerSession(authOptions)\r\n      if (!session?.user) {\r\n        return formatErrorResponse('Unauthorized', 401)\r\n      }\r\n\r\n      const body = await request.json()\r\n      const { ticket_id, status, response } = UpdateTicketSchema.parse(body)\r\n\r\n      // Update ticket in database\r\n      // This would be implemented with your database\r\n      const updatedTicket = await updateTicket(ticket_id, session.user.id, { status, response })\r\n\r\n      if (!updatedTicket) {\r\n        return formatErrorResponse('Ticket not found', 404)\r\n      }\r\n\r\n      return NextResponse.json({\r\n        success: true,\r\n        data: {\r\n          ticket: updatedTicket,\r\n          message: 'Ticket updated successfully'\r\n        }\r\n      })\r\n\r\n    } catch (error) {\r\n      logger.error('Failed to update support ticket', { error })\r\n      return formatErrorResponse('Failed to update ticket', 500)\r\n    }\r\n  })\r\n}\r\n\r\n// Helper functions (these would be implemented with your database)\r\nasync function getUserTickets(userId: string, limit: number, offset: number) {\r\n  // This would query your database for user's tickets\r\n  // For now, return empty array\r\n  return []\r\n}\r\n\r\nasync function updateTicket(ticketId: string, userId: string, updates: any) {\r\n  // This would update the ticket in your database\r\n  // For now, return null\r\n  return null\r\n}\r\n\r\nasync function sendSupportNotification(ticket: any) {\r\n  // Send notification to support team\r\n  // This could be via email, Slack, or other notification system\r\n  logger.info('Support notification sent', {\r\n    ticketId: ticket.id,\r\n    subject: ticket.subject,\r\n    priority: ticket.priority,\r\n  })\r\n}\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}