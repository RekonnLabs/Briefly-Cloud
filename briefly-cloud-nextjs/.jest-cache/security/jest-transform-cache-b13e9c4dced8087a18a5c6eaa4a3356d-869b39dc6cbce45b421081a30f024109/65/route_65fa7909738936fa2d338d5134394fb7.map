{"version":3,"names":["cov_swy3esj9i","actualCoverage","s","GET","listOneDriveFilesHandler","_request","context","f","user","b","_apiutils","ApiResponse","unauthorized","data","token","_supabase","supabaseAdmin","from","select","eq","id","single","access_token","badRequest","resp","fetch","headers","Authorization","ok","internalError","json","files","value","map","name","size","mimeType","file","webUrl","success","_apimiddleware","createProtectedApiHandler","rateLimit","_ratelimit","rateLimitConfigs","general","logging","enabled","includeBody"],"sources":["R:\\Apps\\Briefly_Cloud\\briefly-cloud-nextjs\\src\\app\\api\\storage\\microsoft\\list\\route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\r\nimport { createProtectedApiHandler, ApiContext } from '@/app/lib/api-middleware'\r\nimport { ApiResponse } from '@/app/lib/api-utils'\r\nimport { rateLimitConfigs } from '@/app/lib/rate-limit'\r\nimport { supabaseAdmin } from '@/app/lib/supabase'\r\n\r\nasync function listOneDriveFilesHandler(_request: Request, context: ApiContext): Promise<NextResponse> {\r\n  const { user } = context\r\n  if (!user) return ApiResponse.unauthorized('User not authenticated')\r\n\r\n  const { data: token } = await supabaseAdmin\r\n    .from('oauth_tokens')\r\n    .select('*')\r\n    .eq('user_id', user.id)\r\n    .eq('provider', 'microsoft')\r\n    .single()\r\n\r\n  if (!token?.access_token) return ApiResponse.badRequest('Microsoft account not connected')\r\n\r\n  const resp = await fetch('https://graph.microsoft.com/v1.0/me/drive/root/children', {\r\n    headers: { Authorization: `Bearer ${token.access_token}` },\r\n  })\r\n  if (!resp.ok) return ApiResponse.internalError('Failed to list OneDrive files')\r\n  const data = await resp.json()\r\n\r\n  const files = (data.value || []).map((f: any) => ({\r\n    id: f.id,\r\n    name: f.name,\r\n    size: f.size,\r\n    mimeType: f.file?.mimeType,\r\n    webUrl: f.webUrl,\r\n  }))\r\n\r\n  return ApiResponse.success({ files })\r\n}\r\n\r\nexport const GET = createProtectedApiHandler(listOneDriveFilesHandler, {\r\n  rateLimit: rateLimitConfigs.general,\r\n  logging: { enabled: true, includeBody: false },\r\n})\r\n\r\n\r\n\r\n"],"mappings":"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","ignoreList":[]}