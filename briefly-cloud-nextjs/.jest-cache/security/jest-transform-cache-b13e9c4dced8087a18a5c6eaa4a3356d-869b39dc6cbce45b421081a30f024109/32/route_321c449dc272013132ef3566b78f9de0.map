{"version":3,"names":["GET","cov_9dyvpoqoy","f","s","POST","AnalyticsEventSchema","_zod","z","object","event","string","properties","record","any","optional","userId","sessionId","timestamp","datetime","request","_ratelimit","withRateLimit","body","json","parse","session","_nextauth","getServerSession","_auth","authOptions","currentUserId","b","user","id","supabase","_supabase","supabaseAdmin","error","from","insert","crypto","randomUUID","user_id","session_id","created_at","Date","toISOString","_logger","logger","_apierrors","formatErrorResponse","info","_server","NextResponse","success","message","data","events","select","eq","order","ascending","limit","count","length"],"sources":["R:\\Apps\\Briefly_Cloud\\briefly-cloud-nextjs\\src\\app\\api\\analytics\\track\\route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\r\nimport { z } from 'zod'\r\nimport { getServerSession } from 'next-auth'\r\nimport { authOptions } from '@/app/lib/auth'\r\nimport { logger } from '@/app/lib/logger'\r\nimport { formatErrorResponse } from '@/app/lib/api-errors'\r\nimport { withRateLimit } from '@/app/lib/rate-limit'\r\nimport { createClient } from '@supabase/supabase-js'\r\nimport { supabaseAdmin } from '@/app/lib/supabase'\n\r\n// Analytics event schema\r\nconst AnalyticsEventSchema = z.object({\r\n  event: z.string(),\r\n  properties: z.record(z.any()).optional(),\r\n  userId: z.string().optional(),\r\n  sessionId: z.string(),\r\n  timestamp: z.string().datetime(),\r\n})\r\n\r\nexport async function POST(request: NextRequest) {\r\n  return withRateLimit(request, async () => {\r\n    try {\r\n      const body = await request.json()\r\n      const { event, properties, userId, sessionId, timestamp } = AnalyticsEventSchema.parse(body)\r\n\r\n      // Get user session if available\r\n      const session = await getServerSession(authOptions)\r\n      const currentUserId = userId || session?.user?.id\r\n\r\n      // Store analytics event in database\r\n      const supabase = supabaseAdmin\r\n\r\n      const { error } = await supabase\r\n        .from('analytics_events')\r\n        .insert({\r\n          id: crypto.randomUUID(),\r\n          event,\r\n          properties: properties || {},\r\n          user_id: currentUserId,\r\n          session_id: sessionId,\r\n          timestamp,\r\n          created_at: new Date().toISOString(),\r\n        })\r\n\r\n      if (error) {\r\n        logger.error('Failed to store analytics event', { error, event })\r\n        return formatErrorResponse('Failed to track event', 500)\r\n      }\r\n\r\n      logger.info('Analytics event tracked', { event, userId: currentUserId, sessionId })\r\n\r\n      return NextResponse.json({\r\n        success: true,\r\n        message: 'Event tracked successfully'\r\n      })\r\n\r\n    } catch (error) {\r\n      logger.error('Analytics tracking error', { error })\r\n      return formatErrorResponse('Invalid request', 400)\r\n    }\r\n  })\r\n}\r\n\r\nexport async function GET(request: NextRequest) {\r\n  return withRateLimit(request, async () => {\r\n    try {\r\n      // Check authentication\r\n      const session = await getServerSession(authOptions)\r\n      if (!session?.user) {\r\n        return formatErrorResponse('Unauthorized', 401)\r\n      }\r\n\r\n      // Get analytics events for the user\r\n      const supabase = supabaseAdmin\r\n\r\n      const { data: events, error } = await supabase\r\n        .from('analytics_events')\r\n        .select('*')\r\n        .eq('user_id', session.user.id)\r\n        .order('created_at', { ascending: false })\r\n        .limit(100)\r\n\r\n      if (error) {\r\n        logger.error('Failed to get analytics events', { error })\r\n        return formatErrorResponse('Failed to retrieve events', 500)\r\n      }\r\n\r\n      return NextResponse.json({\r\n        success: true,\r\n        data: {\r\n          events: events || [],\r\n          count: events?.length || 0\r\n        }\r\n      })\r\n\r\n    } catch (error) {\r\n      logger.error('Analytics retrieval error', { error })\r\n      return formatErrorResponse('Internal server error', 500)\r\n    }\r\n  })\r\n}\r\n"],"mappings":"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","ignoreList":[]}