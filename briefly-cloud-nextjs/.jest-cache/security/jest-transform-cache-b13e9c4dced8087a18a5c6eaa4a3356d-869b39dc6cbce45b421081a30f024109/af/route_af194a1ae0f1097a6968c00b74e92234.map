{"version":3,"names":["POST","stripe","cov_1u0r7q6sz6","s","_stripe","default","process","env","STRIPE_SECRET_KEY","apiVersion","createCheckoutHandler","request","context","f","user","b","_apiutils","ApiResponse","unauthorized","body","json","catch","tier","includes","badRequest","supabase","_supabase","supabaseAdmin","data","profile","from","select","eq","id","single","customerId","stripe_customer_id","customer","customers","create","email","metadata","user_id","update","priceId","STRIPE_PRICE_PRO","STRIPE_PRICE_PRO_BYOK","internalError","session","checkout","sessions","mode","payment_method_types","line_items","price","quantity","success_url","STRIPE_SUCCESS_URL","cancel_url","STRIPE_CANCEL_URL","success","url","_apimiddleware","createProtectedApiHandler","rateLimit","_ratelimit","rateLimitConfigs","general","logging","enabled","includeBody"],"sources":["R:\\Apps\\Briefly_Cloud\\briefly-cloud-nextjs\\src\\app\\api\\billing\\create-checkout-session\\route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\r\nimport { createProtectedApiHandler, ApiContext } from '@/app/lib/api-middleware'\r\nimport { ApiResponse } from '@/app/lib/api-utils'\r\nimport { rateLimitConfigs } from '@/app/lib/rate-limit'\r\nimport Stripe from 'stripe'\r\nimport { supabaseAdmin } from '@/app/lib/supabase'\r\n\r\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, { apiVersion: '2024-06-20' })\r\n\r\nasync function createCheckoutHandler(request: Request, context: ApiContext): Promise<NextResponse> {\r\n  const { user } = context\r\n  if (!user) return ApiResponse.unauthorized('User not authenticated')\r\n\r\n  const body = await request.json().catch(() => ({})) as { tier?: 'pro' | 'pro_byok' }\r\n  const tier = body.tier || 'pro'\r\n  if (!['pro', 'pro_byok'].includes(tier)) return ApiResponse.badRequest('Invalid tier')\r\n\r\n  const supabase = supabaseAdmin\r\n\r\n  // Ensure customer id\r\n  const { data: profile } = await supabase\r\n    .from('users')\r\n    .select('stripe_customer_id, email')\r\n    .eq('id', user.id)\r\n    .single()\r\n\r\n  let customerId = profile?.stripe_customer_id as string | null\r\n  if (!customerId) {\r\n    const customer = await stripe.customers.create({ email: profile?.email || user.email, metadata: { user_id: user.id } })\r\n    customerId = customer.id\r\n    await supabase\r\n      .from('users')\r\n      .update({ stripe_customer_id: customerId })\r\n      .eq('id', user.id)\r\n  }\r\n\r\n  const priceId = tier === 'pro' ? process.env.STRIPE_PRICE_PRO : process.env.STRIPE_PRICE_PRO_BYOK\r\n  if (!priceId) return ApiResponse.internalError('Price ID not configured')\r\n\r\n  const session = await stripe.checkout.sessions.create({\r\n    customer: customerId,\r\n    mode: 'subscription',\r\n    payment_method_types: ['card'],\r\n    line_items: [{ price: priceId, quantity: 1 }],\r\n    success_url: process.env.STRIPE_SUCCESS_URL!,\r\n    cancel_url: process.env.STRIPE_CANCEL_URL!,\r\n    metadata: { user_id: user.id, tier },\r\n  })\r\n\r\n  return ApiResponse.success({ url: session.url })\r\n}\r\n\r\nexport const POST = createProtectedApiHandler(createCheckoutHandler, {\r\n  rateLimit: rateLimitConfigs.general,\r\n  logging: { enabled: true, includeBody: true },\r\n})\r\n"],"mappings":"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","ignoreList":[]}