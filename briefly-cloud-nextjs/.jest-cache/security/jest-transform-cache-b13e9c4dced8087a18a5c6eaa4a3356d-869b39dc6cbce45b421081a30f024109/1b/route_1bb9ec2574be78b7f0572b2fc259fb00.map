{"version":3,"names":["GET","cov_18c6a042wa","f","s","POST","embeddingRequestSchema","_zod","z","object","text","string","min","max","model","enum","optional","dimensions","number","batchEmbeddingRequestSchema","texts","array","generateEmbeddingHandler","request","context","user","b","_apiutils","ApiResponse","unauthorized","body","json","validation","safeParse","success","badRequest","_embeddings","DEFAULT_EMBEDDING_MODEL","data","embeddingsService","isUserKey","subscription_tier","createClient","Promise","resolve","then","_interop_require_wildcard","require","supabase","_supabase","supabaseAdmin","apiKeyData","from","select","eq","id","single","value","createUserEmbeddingsService","createEmbeddingsService","result","generateEmbedding","modelInfo","getEmbeddingModelInfo","estimatedCost","estimateEmbeddingCost","length","_logger","logApiUsage","text_length","tokens","estimated_cost","is_user_key","embedding","metadata","model_info","text_info","preview","substring","error","console","Error","name","internalError","generateBatchEmbeddingsHandler","generateBatchEmbeddings","text_count","total_tokens","totalTokens","total_cost","totalCost","processing_time","processingTime","embeddings","map","emb","total_texts","average_tokens_per_text","Math","round","texts_info","count","total_length","reduce","sum","average_length","getEmbeddingInfoHandler","_request","capabilities","models","Object","entries","EMBEDDING_MODELS","config","available","recommended_for","default_model","features","single_embedding","description","max_text_length","endpoint","batch_embedding","max_texts_per_batch","chunk_embedding","supports_storage","byok_support","supported","pricing","note","cost_per_1k_tokens","costPer1kTokens","estimated_cost_per_page","limitations","rate_limits","text_limits","max_batch_size","max_tokens_per_request","subscription_tiers","free","pro","pro_byok","user_info","has_byok","can_use_advanced_models","version","last_updated","Date","toISOString","_apimiddleware","createProtectedApiHandler","rateLimit","_ratelimit","rateLimitConfigs","general","maxRequests","logging","enabled","includeBody"],"sources":["R:\\Apps\\Briefly_Cloud\\briefly-cloud-nextjs\\src\\app\\api\\embeddings\\route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\r\nimport { createProtectedApiHandler, ApiContext } from '@/app/lib/api-middleware'\r\nimport { ApiResponse } from '@/app/lib/api-utils'\r\nimport { rateLimitConfigs } from '@/app/lib/rate-limit'\r\nimport { logApiUsage } from '@/app/lib/logger'\r\nimport { \r\n  EmbeddingsService,\r\n  createEmbeddingsService,\r\n  createUserEmbeddingsService,\r\n  EMBEDDING_MODELS,\r\n  DEFAULT_EMBEDDING_MODEL,\r\n  EmbeddingModel,\r\n  estimateEmbeddingCost,\r\n  getEmbeddingModelInfo\r\n} from '@/app/lib/embeddings'\r\nimport { z } from 'zod'\r\nimport { supabaseAdmin } from '@/app/lib/supabase'\n\r\n// Validation schemas\r\nconst embeddingRequestSchema = z.object({\r\n  text: z.string().min(1).max(100000), // Max ~100k characters\r\n  model: z.enum(['text-embedding-3-small', 'text-embedding-3-large', 'text-embedding-ada-002']).optional(),\r\n  dimensions: z.number().min(256).max(3072).optional(),\r\n})\r\n\r\nconst batchEmbeddingRequestSchema = z.object({\r\n  texts: z.array(z.string().min(1)).min(1).max(100), // Max 100 texts at once\r\n  model: z.enum(['text-embedding-3-small', 'text-embedding-3-large', 'text-embedding-ada-002']).optional(),\r\n  dimensions: z.number().min(256).max(3072).optional(),\r\n})\r\n\r\n// POST /api/embeddings - Generate embedding for single text\r\nasync function generateEmbeddingHandler(request: Request, context: ApiContext): Promise<NextResponse> {\r\n  const { user } = context\r\n  \r\n  if (!user) {\r\n    return ApiResponse.unauthorized('User not authenticated')\r\n  }\r\n  \r\n  try {\r\n    const body = await request.json()\r\n    const validation = embeddingRequestSchema.safeParse(body)\r\n    \r\n    if (!validation.success) {\r\n      return ApiResponse.badRequest('Invalid request data')\r\n    }\r\n    \r\n    const { text, model = DEFAULT_EMBEDDING_MODEL, dimensions } = validation.data\r\n    \r\n    // Check if user has BYOK tier and their own API key\r\n    let embeddingsService: EmbeddingsService\r\n    let isUserKey = false\r\n    \r\n    if (user.subscription_tier === 'pro_byok') {\r\n      // Try to get user's API key from settings\r\n      const { createClient } = await import('@supabase/supabase-js')\r\n      const supabase = supabaseAdmin\r\n      \r\n      const { data: apiKeyData } = await supabase\r\n        .from('user_settings')\r\n        .select('value')\r\n        .eq('user_id', user.id)\r\n        .eq('key', 'openai_api_key')\r\n        .single()\r\n      \r\n      if (apiKeyData?.value) {\r\n        embeddingsService = createUserEmbeddingsService(apiKeyData.value, { dimensions })\r\n        isUserKey = true\r\n      } else {\r\n        embeddingsService = createEmbeddingsService({ dimensions })\r\n      }\r\n    } else {\r\n      embeddingsService = createEmbeddingsService({ dimensions })\r\n    }\r\n    \r\n    // Generate embedding\r\n    const result = await embeddingsService.generateEmbedding(text, model)\r\n    \r\n    // Calculate cost estimate\r\n    const modelInfo = getEmbeddingModelInfo(model)\r\n    const estimatedCost = estimateEmbeddingCost(text.length, model)\r\n    \r\n    // Log usage\r\n    logApiUsage(user.id, '/api/embeddings', 'embedding_generation', {\r\n      model,\r\n      text_length: text.length,\r\n      tokens: result.tokens,\r\n      dimensions: result.dimensions,\r\n      estimated_cost: estimatedCost,\r\n      is_user_key: isUserKey,\r\n    })\r\n    \r\n    return ApiResponse.success({\r\n      embedding: result.embedding,\r\n      metadata: {\r\n        model: result.model,\r\n        dimensions: result.dimensions,\r\n        tokens: result.tokens,\r\n        estimated_cost: estimatedCost,\r\n        model_info: modelInfo,\r\n        is_user_key: isUserKey,\r\n      },\r\n      text_info: {\r\n        length: text.length,\r\n        preview: text.substring(0, 100) + (text.length > 100 ? '...' : ''),\r\n      },\r\n    }, 'Embedding generated successfully')\r\n    \r\n  } catch (error) {\r\n    console.error('Generate embedding handler error:', error)\r\n    \r\n    if (error instanceof Error && error.name === 'AppError') {\r\n      throw error\r\n    }\r\n    \r\n    return ApiResponse.internalError('Failed to generate embedding')\r\n  }\r\n}\r\n\r\n// POST /api/embeddings/batch - Generate embeddings for multiple texts\r\nasync function generateBatchEmbeddingsHandler(request: Request, context: ApiContext): Promise<NextResponse> {\r\n  const { user } = context\r\n  \r\n  if (!user) {\r\n    return ApiResponse.unauthorized('User not authenticated')\r\n  }\r\n  \r\n  try {\r\n    const body = await request.json()\r\n    const validation = batchEmbeddingRequestSchema.safeParse(body)\r\n    \r\n    if (!validation.success) {\r\n      return ApiResponse.badRequest('Invalid request data')\r\n    }\r\n    \r\n    const { texts, model = DEFAULT_EMBEDDING_MODEL, dimensions } = validation.data\r\n    \r\n    // Check if user has BYOK tier and their own API key\r\n    let embeddingsService: EmbeddingsService\r\n    let isUserKey = false\r\n    \r\n    if (user.subscription_tier === 'pro_byok') {\r\n      const { createClient } = await import('@supabase/supabase-js')\r\n      const supabase = supabaseAdmin\r\n      \r\n      const { data: apiKeyData } = await supabase\r\n        .from('user_settings')\r\n        .select('value')\r\n        .eq('user_id', user.id)\r\n        .eq('key', 'openai_api_key')\r\n        .single()\r\n      \r\n      if (apiKeyData?.value) {\r\n        embeddingsService = createUserEmbeddingsService(apiKeyData.value, { dimensions })\r\n        isUserKey = true\r\n      } else {\r\n        embeddingsService = createEmbeddingsService({ dimensions })\r\n      }\r\n    } else {\r\n      embeddingsService = createEmbeddingsService({ dimensions })\r\n    }\r\n    \r\n    // Generate batch embeddings\r\n    const result = await embeddingsService.generateBatchEmbeddings(texts, model)\r\n    \r\n    // Log usage\r\n    logApiUsage(user.id, '/api/embeddings/batch', 'batch_embedding_generation', {\r\n      model,\r\n      text_count: texts.length,\r\n      total_tokens: result.totalTokens,\r\n      total_cost: result.totalCost,\r\n      processing_time: result.processingTime,\r\n      is_user_key: isUserKey,\r\n    })\r\n    \r\n    return ApiResponse.success({\r\n      embeddings: result.embeddings.map(emb => emb.embedding),\r\n      metadata: {\r\n        model: result.model,\r\n        total_texts: texts.length,\r\n        total_tokens: result.totalTokens,\r\n        total_cost: result.totalCost,\r\n        processing_time: result.processingTime,\r\n        average_tokens_per_text: Math.round(result.totalTokens / texts.length),\r\n        model_info: getEmbeddingModelInfo(model),\r\n        is_user_key: isUserKey,\r\n      },\r\n      texts_info: {\r\n        count: texts.length,\r\n        total_length: texts.reduce((sum, text) => sum + text.length, 0),\r\n        average_length: Math.round(texts.reduce((sum, text) => sum + text.length, 0) / texts.length),\r\n      },\r\n    }, 'Batch embeddings generated successfully')\r\n    \r\n  } catch (error) {\r\n    console.error('Generate batch embeddings handler error:', error)\r\n    \r\n    if (error instanceof Error && error.name === 'AppError') {\r\n      throw error\r\n    }\r\n    \r\n    return ApiResponse.internalError('Failed to generate batch embeddings')\r\n  }\r\n}\r\n\r\n// GET /api/embeddings - Get embedding capabilities and model information\r\nasync function getEmbeddingInfoHandler(_request: Request, context: ApiContext): Promise<NextResponse> {\r\n  const { user } = context\r\n  \r\n  if (!user) {\r\n    return ApiResponse.unauthorized('User not authenticated')\r\n  }\r\n  \r\n  try {\r\n    const capabilities = {\r\n      models: Object.entries(EMBEDDING_MODELS).map(([name, config]) => ({\r\n        name,\r\n        ...config,\r\n        available: true,\r\n        recommended_for: name === 'text-embedding-3-small' \r\n          ? ['general_use', 'cost_effective', 'fast_processing']\r\n          : name === 'text-embedding-3-large'\r\n          ? ['high_accuracy', 'advanced_search', 'complex_documents']\r\n          : ['legacy_compatibility'],\r\n      })),\r\n      \r\n      default_model: DEFAULT_EMBEDDING_MODEL,\r\n      \r\n      features: {\r\n        single_embedding: {\r\n          description: 'Generate embedding for a single text',\r\n          max_text_length: 100000,\r\n          endpoint: 'POST /api/embeddings',\r\n        },\r\n        batch_embedding: {\r\n          description: 'Generate embeddings for multiple texts',\r\n          max_texts_per_batch: 100,\r\n          max_text_length: 100000,\r\n          endpoint: 'POST /api/embeddings/batch',\r\n        },\r\n        chunk_embedding: {\r\n          description: 'Generate embeddings for document chunks',\r\n          supports_storage: true,\r\n          endpoint: 'POST /api/embeddings/chunks/{fileId}',\r\n        },\r\n        byok_support: {\r\n          description: 'Bring Your Own Key for Pro BYOK users',\r\n          supported: true,\r\n          models: ['text-embedding-3-small', 'text-embedding-3-large'],\r\n        },\r\n      },\r\n      \r\n      pricing: {\r\n        note: 'Pricing applies when using system API key. BYOK users use their own OpenAI credits.',\r\n        models: Object.entries(EMBEDDING_MODELS).map(([name, config]) => ({\r\n          model: name,\r\n          cost_per_1k_tokens: config.costPer1kTokens,\r\n          estimated_cost_per_page: config.costPer1kTokens * 0.75, // ~750 tokens per page\r\n        })),\r\n      },\r\n      \r\n      limitations: {\r\n        rate_limits: {\r\n          single_embedding: '100 requests per 15 minutes',\r\n          batch_embedding: '20 requests per 15 minutes',\r\n          chunk_embedding: '10 requests per hour',\r\n        },\r\n        text_limits: {\r\n          max_text_length: 100000,\r\n          max_batch_size: 100,\r\n          max_tokens_per_request: 8191,\r\n        },\r\n        subscription_tiers: {\r\n          free: 'System API key only, basic rate limits',\r\n          pro: 'System API key, higher rate limits',\r\n          pro_byok: 'User API key support, highest rate limits',\r\n        },\r\n      },\r\n      \r\n      user_info: {\r\n        subscription_tier: user.subscription_tier,\r\n        has_byok: user.subscription_tier === 'pro_byok',\r\n        can_use_advanced_models: user.subscription_tier !== 'free',\r\n      },\r\n      \r\n      version: '1.0.0',\r\n      last_updated: new Date().toISOString(),\r\n    }\r\n    \r\n    return ApiResponse.success(capabilities)\r\n    \r\n  } catch (error) {\r\n    console.error('Get embedding info handler error:', error)\r\n    return ApiResponse.internalError('Failed to get embedding information')\r\n  }\r\n}\r\n\r\n// Export handlers with middleware\r\nexport const POST = createProtectedApiHandler(generateEmbeddingHandler, {\r\n  rateLimit: {\r\n    ...rateLimitConfigs.general,\r\n    maxRequests: 100, // More generous for embeddings\r\n  },\r\n  logging: {\r\n    enabled: true,\r\n    includeBody: false, // Don't log text content for privacy\r\n  },\r\n})\r\n\r\nexport const GET = createProtectedApiHandler(getEmbeddingInfoHandler, {\r\n  rateLimit: rateLimitConfigs.general,\r\n  logging: {\r\n    enabled: true,\r\n    includeBody: false,\r\n  },\r\n})"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;MAqTaA,IAAA;IAAA;IAAAC,cAAA,GAAAC,CAAA;IAAAD,cAAA,GAAAE,CAAA;WAAAH,GAAA;;MAXAI,KAAA;IAAA;IAAAH,cAAA,GAAAC,CAAA;IAAAD,cAAA,GAAAE,CAAA;WAAAC,IAAA;;;;;kCAzSyC;;;kCAC1B;;;kCACK;;;kCACL;;;mCAUrB;;;mCACW;;;mCACY;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAE9B;AACA,MAAMC,sBAAA;AAAA;AAAA,CAAAJ,cAAA,GAAAE,CAAA,QAAyBG,IAAA,CAAAC,CAAC,CAACC,MAAM,CAAC;EACtCC,IAAA,EAAMH,IAAA,CAAAC,CAAC,CAACG,MAAM,GAAGC,GAAG,CAAC,GAAGC,GAAG,CAAC;EAC5BC,KAAA,EAAOP,IAAA,CAAAC,CAAC,CAACO,IAAI,CAAC,CAAC,0BAA0B,0BAA0B,yBAAyB,EAAEC,QAAQ;EACtGC,UAAA,EAAYV,IAAA,CAAAC,CAAC,CAACU,MAAM,GAAGN,GAAG,CAAC,KAAKC,GAAG,CAAC,MAAMG,QAAQ;AACpD;AAEA,MAAMG,2BAAA;AAAA;AAAA,CAAAjB,cAAA,GAAAE,CAAA,QAA8BG,IAAA,CAAAC,CAAC,CAACC,MAAM,CAAC;EAC3CW,KAAA,EAAOb,IAAA,CAAAC,CAAC,CAACa,KAAK,CAACd,IAAA,CAAAC,CAAC,CAACG,MAAM,GAAGC,GAAG,CAAC,IAAIA,GAAG,CAAC,GAAGC,GAAG,CAAC;EAC7CC,KAAA,EAAOP,IAAA,CAAAC,CAAC,CAACO,IAAI,CAAC,CAAC,0BAA0B,0BAA0B,yBAAyB,EAAEC,QAAQ;EACtGC,UAAA,EAAYV,IAAA,CAAAC,CAAC,CAACU,MAAM,GAAGN,GAAG,CAAC,KAAKC,GAAG,CAAC,MAAMG,QAAQ;AACpD;AAEA;AACA,eAAeM,yBAAyBC,OAAgB,EAAEC,OAAmB;EAAA;EAAAtB,cAAA,GAAAC,CAAA;EAC3E,MAAM;IAAEsB;EAAI,CAAE;EAAA;EAAA,CAAAvB,cAAA,GAAAE,CAAA,QAAGoB,OAAA;EAAA;EAAAtB,cAAA,GAAAE,CAAA;EAEjB,IAAI,CAACqB,IAAA,EAAM;IAAA;IAAAvB,cAAA,GAAAwB,CAAA;IAAAxB,cAAA,GAAAE,CAAA;IACT,OAAOuB,SAAA,CAAAC,WAAW,CAACC,YAAY,CAAC;EAClC;EAAA;EAAA;IAAA3B,cAAA,GAAAwB,CAAA;EAAA;EAAAxB,cAAA,GAAAE,CAAA;EAEA,IAAI;IACF,MAAM0B,IAAA;IAAA;IAAA,CAAA5B,cAAA,GAAAE,CAAA,QAAO,MAAMmB,OAAA,CAAQQ,IAAI;IAC/B,MAAMC,UAAA;IAAA;IAAA,CAAA9B,cAAA,GAAAE,CAAA,QAAaE,sBAAA,CAAuB2B,SAAS,CAACH,IAAA;IAAA;IAAA5B,cAAA,GAAAE,CAAA;IAEpD,IAAI,CAAC4B,UAAA,CAAWE,OAAO,EAAE;MAAA;MAAAhC,cAAA,GAAAwB,CAAA;MAAAxB,cAAA,GAAAE,CAAA;MACvB,OAAOuB,SAAA,CAAAC,WAAW,CAACO,UAAU,CAAC;IAChC;IAAA;IAAA;MAAAjC,cAAA,GAAAwB,CAAA;IAAA;IAEA,MAAM;MAAEhB,IAAI;MAAEI,KAAA;MAAA;MAAA,CAAAZ,cAAA,GAAAwB,CAAA,WAAQU,WAAA,CAAAC,uBAAuB;MAAEpB;IAAU,CAAE;IAAA;IAAA,CAAAf,cAAA,GAAAE,CAAA,QAAG4B,UAAA,CAAWM,IAAI;IAE7E;IACA,IAAIC,iBAAA;IACJ,IAAIC,SAAA;IAAA;IAAA,CAAAtC,cAAA,GAAAE,CAAA,QAAY;IAAA;IAAAF,cAAA,GAAAE,CAAA;IAEhB,IAAIqB,IAAA,CAAKgB,iBAAiB,KAAK,YAAY;MAAA;MAAAvC,cAAA,GAAAwB,CAAA;MACzC;MACA,MAAM;QAAEgB;MAAY,CAAE;MAAA;MAAA,CAAAxC,cAAA,GAAAE,CAAA,QAAG,MAAMuC,OAAA,CAAAC,OAAA,GAAAC,IAAA;QAAA;QAAA3C,cAAA,GAAAC,CAAA;QAAAD,cAAA,GAAAE,CAAA;QAAA,oBAAA0C,yBAAA,CAAAC,OAAA,CAAO;MAAA;MACtC,MAAMC,QAAA;MAAA;MAAA,CAAA9C,cAAA,GAAAE,CAAA,QAAW6C,SAAA,CAAAC,aAAa;MAE9B,MAAM;QAAEZ,IAAA,EAAMa;MAAU,CAAE;MAAA;MAAA,CAAAjD,cAAA,GAAAE,CAAA,QAAG,MAAM4C,QAAA,CAChCI,IAAI,CAAC,iBACLC,MAAM,CAAC,SACPC,EAAE,CAAC,WAAW7B,IAAA,CAAK8B,EAAE,EACrBD,EAAE,CAAC,OAAO,kBACVE,MAAM;MAAA;MAAAtD,cAAA,GAAAE,CAAA;MAET,IAAI+C,UAAA,EAAYM,KAAA,EAAO;QAAA;QAAAvD,cAAA,GAAAwB,CAAA;QAAAxB,cAAA,GAAAE,CAAA;QACrBmC,iBAAA,GAAoB,IAAAH,WAAA,CAAAsB,2BAA2B,EAACP,UAAA,CAAWM,KAAK,EAAE;UAAExC;QAAW;QAAA;QAAAf,cAAA,GAAAE,CAAA;QAC/EoC,SAAA,GAAY;MACd,OAAO;QAAA;QAAAtC,cAAA,GAAAwB,CAAA;QAAAxB,cAAA,GAAAE,CAAA;QACLmC,iBAAA,GAAoB,IAAAH,WAAA,CAAAuB,uBAAuB,EAAC;UAAE1C;QAAW;MAC3D;IACF,OAAO;MAAA;MAAAf,cAAA,GAAAwB,CAAA;MAAAxB,cAAA,GAAAE,CAAA;MACLmC,iBAAA,GAAoB,IAAAH,WAAA,CAAAuB,uBAAuB,EAAC;QAAE1C;MAAW;IAC3D;IAEA;IACA,MAAM2C,MAAA;IAAA;IAAA,CAAA1D,cAAA,GAAAE,CAAA,QAAS,MAAMmC,iBAAA,CAAkBsB,iBAAiB,CAACnD,IAAA,EAAMI,KAAA;IAE/D;IACA,MAAMgD,SAAA;IAAA;IAAA,CAAA5D,cAAA,GAAAE,CAAA,QAAY,IAAAgC,WAAA,CAAA2B,qBAAqB,EAACjD,KAAA;IACxC,MAAMkD,aAAA;IAAA;IAAA,CAAA9D,cAAA,GAAAE,CAAA,QAAgB,IAAAgC,WAAA,CAAA6B,qBAAqB,EAACvD,IAAA,CAAKwD,MAAM,EAAEpD,KAAA;IAEzD;IAAA;IAAAZ,cAAA,GAAAE,CAAA;IACA,IAAA+D,OAAA,CAAAC,WAAW,EAAC3C,IAAA,CAAK8B,EAAE,EAAE,mBAAmB,wBAAwB;MAC9DzC,KAAA;MACAuD,WAAA,EAAa3D,IAAA,CAAKwD,MAAM;MACxBI,MAAA,EAAQV,MAAA,CAAOU,MAAM;MACrBrD,UAAA,EAAY2C,MAAA,CAAO3C,UAAU;MAC7BsD,cAAA,EAAgBP,aAAA;MAChBQ,WAAA,EAAahC;IACf;IAAA;IAAAtC,cAAA,GAAAE,CAAA;IAEA,OAAOuB,SAAA,CAAAC,WAAW,CAACM,OAAO,CAAC;MACzBuC,SAAA,EAAWb,MAAA,CAAOa,SAAS;MAC3BC,QAAA,EAAU;QACR5D,KAAA,EAAO8C,MAAA,CAAO9C,KAAK;QACnBG,UAAA,EAAY2C,MAAA,CAAO3C,UAAU;QAC7BqD,MAAA,EAAQV,MAAA,CAAOU,MAAM;QACrBC,cAAA,EAAgBP,aAAA;QAChBW,UAAA,EAAYb,SAAA;QACZU,WAAA,EAAahC;MACf;MACAoC,SAAA,EAAW;QACTV,MAAA,EAAQxD,IAAA,CAAKwD,MAAM;QACnBW,OAAA,EAASnE,IAAA,CAAKoE,SAAS,CAAC,GAAG,QAAQpE,IAAA,CAAKwD,MAAM,GAAG;QAAA;QAAA,CAAAhE,cAAA,GAAAwB,CAAA,WAAM;QAAA;QAAA,CAAAxB,cAAA,GAAAwB,CAAA,WAAQ,EAAC;MAClE;IACF,GAAG;EAEL,EAAE,OAAOqD,KAAA,EAAO;IAAA;IAAA7E,cAAA,GAAAE,CAAA;IACd4E,OAAA,CAAQD,KAAK,CAAC,qCAAqCA,KAAA;IAAA;IAAA7E,cAAA,GAAAE,CAAA;IAEnD;IAAI;IAAA,CAAAF,cAAA,GAAAwB,CAAA,WAAAqD,KAAA,YAAiBE,KAAA;IAAA;IAAA,CAAA/E,cAAA,GAAAwB,CAAA,WAASqD,KAAA,CAAMG,IAAI,KAAK,aAAY;MAAA;MAAAhF,cAAA,GAAAwB,CAAA;MAAAxB,cAAA,GAAAE,CAAA;MACvD,MAAM2E,KAAA;IACR;IAAA;IAAA;MAAA7E,cAAA,GAAAwB,CAAA;IAAA;IAAAxB,cAAA,GAAAE,CAAA;IAEA,OAAOuB,SAAA,CAAAC,WAAW,CAACuD,aAAa,CAAC;EACnC;AACF;AAEA;AACA,eAAeC,+BAA+B7D,OAAgB,EAAEC,OAAmB;EAAA;EAAAtB,cAAA,GAAAC,CAAA;EACjF,MAAM;IAAEsB;EAAI,CAAE;EAAA;EAAA,CAAAvB,cAAA,GAAAE,CAAA,QAAGoB,OAAA;EAAA;EAAAtB,cAAA,GAAAE,CAAA;EAEjB,IAAI,CAACqB,IAAA,EAAM;IAAA;IAAAvB,cAAA,GAAAwB,CAAA;IAAAxB,cAAA,GAAAE,CAAA;IACT,OAAOuB,SAAA,CAAAC,WAAW,CAACC,YAAY,CAAC;EAClC;EAAA;EAAA;IAAA3B,cAAA,GAAAwB,CAAA;EAAA;EAAAxB,cAAA,GAAAE,CAAA;EAEA,IAAI;IACF,MAAM0B,IAAA;IAAA;IAAA,CAAA5B,cAAA,GAAAE,CAAA,QAAO,MAAMmB,OAAA,CAAQQ,IAAI;IAC/B,MAAMC,UAAA;IAAA;IAAA,CAAA9B,cAAA,GAAAE,CAAA,QAAae,2BAAA,CAA4Bc,SAAS,CAACH,IAAA;IAAA;IAAA5B,cAAA,GAAAE,CAAA;IAEzD,IAAI,CAAC4B,UAAA,CAAWE,OAAO,EAAE;MAAA;MAAAhC,cAAA,GAAAwB,CAAA;MAAAxB,cAAA,GAAAE,CAAA;MACvB,OAAOuB,SAAA,CAAAC,WAAW,CAACO,UAAU,CAAC;IAChC;IAAA;IAAA;MAAAjC,cAAA,GAAAwB,CAAA;IAAA;IAEA,MAAM;MAAEN,KAAK;MAAEN,KAAA;MAAA;MAAA,CAAAZ,cAAA,GAAAwB,CAAA,WAAQU,WAAA,CAAAC,uBAAuB;MAAEpB;IAAU,CAAE;IAAA;IAAA,CAAAf,cAAA,GAAAE,CAAA,QAAG4B,UAAA,CAAWM,IAAI;IAE9E;IACA,IAAIC,iBAAA;IACJ,IAAIC,SAAA;IAAA;IAAA,CAAAtC,cAAA,GAAAE,CAAA,QAAY;IAAA;IAAAF,cAAA,GAAAE,CAAA;IAEhB,IAAIqB,IAAA,CAAKgB,iBAAiB,KAAK,YAAY;MAAA;MAAAvC,cAAA,GAAAwB,CAAA;MACzC,MAAM;QAAEgB;MAAY,CAAE;MAAA;MAAA,CAAAxC,cAAA,GAAAE,CAAA,QAAG,MAAMuC,OAAA,CAAAC,OAAA,GAAAC,IAAA;QAAA;QAAA3C,cAAA,GAAAC,CAAA;QAAAD,cAAA,GAAAE,CAAA;QAAA,oBAAA0C,yBAAA,CAAAC,OAAA,CAAO;MAAA;MACtC,MAAMC,QAAA;MAAA;MAAA,CAAA9C,cAAA,GAAAE,CAAA,QAAW6C,SAAA,CAAAC,aAAa;MAE9B,MAAM;QAAEZ,IAAA,EAAMa;MAAU,CAAE;MAAA;MAAA,CAAAjD,cAAA,GAAAE,CAAA,QAAG,MAAM4C,QAAA,CAChCI,IAAI,CAAC,iBACLC,MAAM,CAAC,SACPC,EAAE,CAAC,WAAW7B,IAAA,CAAK8B,EAAE,EACrBD,EAAE,CAAC,OAAO,kBACVE,MAAM;MAAA;MAAAtD,cAAA,GAAAE,CAAA;MAET,IAAI+C,UAAA,EAAYM,KAAA,EAAO;QAAA;QAAAvD,cAAA,GAAAwB,CAAA;QAAAxB,cAAA,GAAAE,CAAA;QACrBmC,iBAAA,GAAoB,IAAAH,WAAA,CAAAsB,2BAA2B,EAACP,UAAA,CAAWM,KAAK,EAAE;UAAExC;QAAW;QAAA;QAAAf,cAAA,GAAAE,CAAA;QAC/EoC,SAAA,GAAY;MACd,OAAO;QAAA;QAAAtC,cAAA,GAAAwB,CAAA;QAAAxB,cAAA,GAAAE,CAAA;QACLmC,iBAAA,GAAoB,IAAAH,WAAA,CAAAuB,uBAAuB,EAAC;UAAE1C;QAAW;MAC3D;IACF,OAAO;MAAA;MAAAf,cAAA,GAAAwB,CAAA;MAAAxB,cAAA,GAAAE,CAAA;MACLmC,iBAAA,GAAoB,IAAAH,WAAA,CAAAuB,uBAAuB,EAAC;QAAE1C;MAAW;IAC3D;IAEA;IACA,MAAM2C,MAAA;IAAA;IAAA,CAAA1D,cAAA,GAAAE,CAAA,QAAS,MAAMmC,iBAAA,CAAkB8C,uBAAuB,CAACjE,KAAA,EAAON,KAAA;IAEtE;IAAA;IAAAZ,cAAA,GAAAE,CAAA;IACA,IAAA+D,OAAA,CAAAC,WAAW,EAAC3C,IAAA,CAAK8B,EAAE,EAAE,yBAAyB,8BAA8B;MAC1EzC,KAAA;MACAwE,UAAA,EAAYlE,KAAA,CAAM8C,MAAM;MACxBqB,YAAA,EAAc3B,MAAA,CAAO4B,WAAW;MAChCC,UAAA,EAAY7B,MAAA,CAAO8B,SAAS;MAC5BC,eAAA,EAAiB/B,MAAA,CAAOgC,cAAc;MACtCpB,WAAA,EAAahC;IACf;IAAA;IAAAtC,cAAA,GAAAE,CAAA;IAEA,OAAOuB,SAAA,CAAAC,WAAW,CAACM,OAAO,CAAC;MACzB2D,UAAA,EAAYjC,MAAA,CAAOiC,UAAU,CAACC,GAAG,CAACC,GAAA,IAAO;QAAA;QAAA7F,cAAA,GAAAC,CAAA;QAAAD,cAAA,GAAAE,CAAA;QAAA,OAAA2F,GAAA,CAAItB,SAAS;MAAT,CAAS;MACtDC,QAAA,EAAU;QACR5D,KAAA,EAAO8C,MAAA,CAAO9C,KAAK;QACnBkF,WAAA,EAAa5E,KAAA,CAAM8C,MAAM;QACzBqB,YAAA,EAAc3B,MAAA,CAAO4B,WAAW;QAChCC,UAAA,EAAY7B,MAAA,CAAO8B,SAAS;QAC5BC,eAAA,EAAiB/B,MAAA,CAAOgC,cAAc;QACtCK,uBAAA,EAAyBC,IAAA,CAAKC,KAAK,CAACvC,MAAA,CAAO4B,WAAW,GAAGpE,KAAA,CAAM8C,MAAM;QACrES,UAAA,EAAY,IAAAvC,WAAA,CAAA2B,qBAAqB,EAACjD,KAAA;QAClC0D,WAAA,EAAahC;MACf;MACA4D,UAAA,EAAY;QACVC,KAAA,EAAOjF,KAAA,CAAM8C,MAAM;QACnBoC,YAAA,EAAclF,KAAA,CAAMmF,MAAM,CAAC,CAACC,GAAA,EAAK9F,IAAA,KAAS;UAAA;UAAAR,cAAA,GAAAC,CAAA;UAAAD,cAAA,GAAAE,CAAA;UAAA,OAAAoG,GAAA,GAAM9F,IAAA,CAAKwD,MAAM;QAAN,CAAM,EAAE;QAC7DuC,cAAA,EAAgBP,IAAA,CAAKC,KAAK,CAAC/E,KAAA,CAAMmF,MAAM,CAAC,CAACC,GAAA,EAAK9F,IAAA,KAAS;UAAA;UAAAR,cAAA,GAAAC,CAAA;UAAAD,cAAA,GAAAE,CAAA;UAAA,OAAAoG,GAAA,GAAM9F,IAAA,CAAKwD,MAAM;QAAN,CAAM,EAAE,KAAK9C,KAAA,CAAM8C,MAAM;MAC7F;IACF,GAAG;EAEL,EAAE,OAAOa,KAAA,EAAO;IAAA;IAAA7E,cAAA,GAAAE,CAAA;IACd4E,OAAA,CAAQD,KAAK,CAAC,4CAA4CA,KAAA;IAAA;IAAA7E,cAAA,GAAAE,CAAA;IAE1D;IAAI;IAAA,CAAAF,cAAA,GAAAwB,CAAA,WAAAqD,KAAA,YAAiBE,KAAA;IAAA;IAAA,CAAA/E,cAAA,GAAAwB,CAAA,WAASqD,KAAA,CAAMG,IAAI,KAAK,aAAY;MAAA;MAAAhF,cAAA,GAAAwB,CAAA;MAAAxB,cAAA,GAAAE,CAAA;MACvD,MAAM2E,KAAA;IACR;IAAA;IAAA;MAAA7E,cAAA,GAAAwB,CAAA;IAAA;IAAAxB,cAAA,GAAAE,CAAA;IAEA,OAAOuB,SAAA,CAAAC,WAAW,CAACuD,aAAa,CAAC;EACnC;AACF;AAEA;AACA,eAAeuB,wBAAwBC,QAAiB,EAAEnF,OAAmB;EAAA;EAAAtB,cAAA,GAAAC,CAAA;EAC3E,MAAM;IAAEsB;EAAI,CAAE;EAAA;EAAA,CAAAvB,cAAA,GAAAE,CAAA,QAAGoB,OAAA;EAAA;EAAAtB,cAAA,GAAAE,CAAA;EAEjB,IAAI,CAACqB,IAAA,EAAM;IAAA;IAAAvB,cAAA,GAAAwB,CAAA;IAAAxB,cAAA,GAAAE,CAAA;IACT,OAAOuB,SAAA,CAAAC,WAAW,CAACC,YAAY,CAAC;EAClC;EAAA;EAAA;IAAA3B,cAAA,GAAAwB,CAAA;EAAA;EAAAxB,cAAA,GAAAE,CAAA;EAEA,IAAI;IACF,MAAMwG,YAAA;IAAA;IAAA,CAAA1G,cAAA,GAAAE,CAAA,SAAe;MACnByG,MAAA,EAAQC,MAAA,CAAOC,OAAO,CAAC3E,WAAA,CAAA4E,gBAAgB,EAAElB,GAAG,CAAC,CAAC,CAACZ,IAAA,EAAM+B,MAAA,CAAO,KAAM;QAAA;QAAA/G,cAAA,GAAAC,CAAA;QAAAD,cAAA,GAAAE,CAAA;QAAA;UAChE8E,IAAA;UACA,GAAG+B,MAAM;UACTC,SAAA,EAAW;UACXC,eAAA,EAAiBjC,IAAA,KAAS;UAAA;UAAA,CAAAhF,cAAA,GAAAwB,CAAA,WACtB,CAAC,eAAe,kBAAkB,kBAAkB;UAAA;UAAA,CAAAxB,cAAA,GAAAwB,CAAA,WACpDwD,IAAA,KAAS;UAAA;UAAA,CAAAhF,cAAA,GAAAwB,CAAA,WACT,CAAC,iBAAiB,mBAAmB,oBAAoB;UAAA;UAAA,CAAAxB,cAAA,GAAAwB,CAAA,WACzD,CAAC,uBAAuB;QAC9B;MAAA;MAEA0F,aAAA,EAAehF,WAAA,CAAAC,uBAAuB;MAEtCgF,QAAA,EAAU;QACRC,gBAAA,EAAkB;UAChBC,WAAA,EAAa;UACbC,eAAA,EAAiB;UACjBC,QAAA,EAAU;QACZ;QACAC,eAAA,EAAiB;UACfH,WAAA,EAAa;UACbI,mBAAA,EAAqB;UACrBH,eAAA,EAAiB;UACjBC,QAAA,EAAU;QACZ;QACAG,eAAA,EAAiB;UACfL,WAAA,EAAa;UACbM,gBAAA,EAAkB;UAClBJ,QAAA,EAAU;QACZ;QACAK,YAAA,EAAc;UACZP,WAAA,EAAa;UACbQ,SAAA,EAAW;UACXlB,MAAA,EAAQ,CAAC,0BAA0B;QACrC;MACF;MAEAmB,OAAA,EAAS;QACPC,IAAA,EAAM;QACNpB,MAAA,EAAQC,MAAA,CAAOC,OAAO,CAAC3E,WAAA,CAAA4E,gBAAgB,EAAElB,GAAG,CAAC,CAAC,CAACZ,IAAA,EAAM+B,MAAA,CAAO,KAAM;UAAA;UAAA/G,cAAA,GAAAC,CAAA;UAAAD,cAAA,GAAAE,CAAA;UAAA;YAChEU,KAAA,EAAOoE,IAAA;YACPgD,kBAAA,EAAoBjB,MAAA,CAAOkB,eAAe;YAC1CC,uBAAA,EAAyBnB,MAAA,CAAOkB,eAAe,GAAG;UACpD;QAAA;MACF;MAEAE,WAAA,EAAa;QACXC,WAAA,EAAa;UACXhB,gBAAA,EAAkB;UAClBI,eAAA,EAAiB;UACjBE,eAAA,EAAiB;QACnB;QACAW,WAAA,EAAa;UACXf,eAAA,EAAiB;UACjBgB,cAAA,EAAgB;UAChBC,sBAAA,EAAwB;QAC1B;QACAC,kBAAA,EAAoB;UAClBC,IAAA,EAAM;UACNC,GAAA,EAAK;UACLC,QAAA,EAAU;QACZ;MACF;MAEAC,SAAA,EAAW;QACTrG,iBAAA,EAAmBhB,IAAA,CAAKgB,iBAAiB;QACzCsG,QAAA,EAAUtH,IAAA,CAAKgB,iBAAiB,KAAK;QACrCuG,uBAAA,EAAyBvH,IAAA,CAAKgB,iBAAiB,KAAK;MACtD;MAEAwG,OAAA,EAAS;MACTC,YAAA,EAAc,IAAIC,IAAA,GAAOC,WAAW;IACtC;IAAA;IAAAlJ,cAAA,GAAAE,CAAA;IAEA,OAAOuB,SAAA,CAAAC,WAAW,CAACM,OAAO,CAAC0E,YAAA;EAE7B,EAAE,OAAO7B,KAAA,EAAO;IAAA;IAAA7E,cAAA,GAAAE,CAAA;IACd4E,OAAA,CAAQD,KAAK,CAAC,qCAAqCA,KAAA;IAAA;IAAA7E,cAAA,GAAAE,CAAA;IACnD,OAAOuB,SAAA,CAAAC,WAAW,CAACuD,aAAa,CAAC;EACnC;AACF;AAGO,MAAM9E,IAAA;AAAA;AAAA,CAAAH,cAAA,GAAAE,CAAA,SAAO,IAAAiJ,cAAA,CAAAC,yBAAyB,EAAChI,wBAAA,EAA0B;EACtEiI,SAAA,EAAW;IACT,GAAGC,UAAA,CAAAC,gBAAgB,CAACC,OAAO;IAC3BC,WAAA,EAAa;EACf;EACAC,OAAA,EAAS;IACPC,OAAA,EAAS;IACTC,WAAA,EAAa;EACf;AACF;AAEO,MAAM7J,GAAA;AAAA;AAAA,CAAAC,cAAA,GAAAE,CAAA,SAAM,IAAAiJ,cAAA,CAAAC,yBAAyB,EAAC5C,uBAAA,EAAyB;EACpE6C,SAAA,EAAWC,UAAA,CAAAC,gBAAgB,CAACC,OAAO;EACnCE,OAAA,EAAS;IACPC,OAAA,EAAS;IACTC,WAAA,EAAa;EACf;AACF","ignoreList":[]}