{"version":3,"names":["cov_2qv0l8ec7t","actualCoverage","s","GET","listFilesHandler","request","context","f","user","b","_apiutils","ApiResponse","unauthorized","supabase","_supabase","supabaseAdmin","url","URL","pagination","parsePaginationParams","searchParams","source","get","processed","search","sortBy","sortOrder","query","from","select","count","eq","id","ilike","ascending","order","range","offset","limit","data","files","error","console","internalError","formattedFiles","map","file","name","size","mime_type","processing_status","external_url","created_at","updated_at","metadata","paginatedResponse","createPaginatedResponse","_logger","logApiUsage","filters","success","_apimiddleware","createProtectedApiHandler","rateLimit","_ratelimit","rateLimitConfigs","general","logging","enabled","includeBody"],"sources":["R:\\Apps\\Briefly_Cloud\\briefly-cloud-nextjs\\src\\app\\api\\upload\\files\\route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\r\nimport { createProtectedApiHandler, ApiContext } from '@/app/lib/api-middleware'\r\nimport { ApiResponse, parsePaginationParams, createPaginatedResponse } from '@/app/lib/api-utils'\r\nimport { rateLimitConfigs } from '@/app/lib/rate-limit'\r\nimport { supabaseAdmin } from '@/app/lib/supabase'\r\nimport { logApiUsage } from '@/app/lib/logger'\r\n\r\n// GET /api/upload/files - List user's uploaded files\r\nasync function listFilesHandler(request: Request, context: ApiContext): Promise<NextResponse> {\r\n  const { user } = context\r\n  \r\n  if (!user) {\r\n    return ApiResponse.unauthorized('User not authenticated')\r\n  }\r\n  \r\n  try {\r\n    const supabase = supabaseAdmin\r\n    \r\n    const url = new URL(request.url)\r\n    const pagination = parsePaginationParams(url.searchParams)\r\n    \r\n    // Parse query parameters\r\n    const source = url.searchParams.get('source') // 'upload', 'google', 'microsoft'\r\n    const processed = url.searchParams.get('processed') // 'true', 'false'\r\n    const search = url.searchParams.get('search') // Search in file names\r\n    const sortBy = url.searchParams.get('sort_by') || 'created_at'\r\n    const sortOrder = url.searchParams.get('sort_order') || 'desc'\r\n    \r\n    // Build query\r\n    let query = supabase\r\n      .from('file_metadata')\r\n      .select('*', { count: 'exact' })\r\n      .eq('user_id', user.id)\r\n    \r\n    // Apply filters\r\n    if (source) {\r\n      query = query.eq('source', source)\r\n    }\r\n    \r\n    if (processed !== null) {\r\n      query = query.eq('processed', processed === 'true')\r\n    }\r\n    \r\n    if (search) {\r\n      query = query.ilike('name', `%${search}%`)\r\n    }\r\n    \r\n    // Apply sorting\r\n    const ascending = sortOrder === 'asc'\r\n    query = query.order(sortBy, { ascending })\r\n    \r\n    // Apply pagination\r\n    query = query.range(\r\n      pagination.offset!,\r\n      pagination.offset! + pagination.limit! - 1\r\n    )\r\n    \r\n    const { data: files, error, count } = await query\r\n    \r\n    if (error) {\r\n      console.error('Files fetch error:', error)\r\n      return ApiResponse.internalError('Failed to fetch files')\r\n    }\r\n    \r\n    // Format file data\r\n    const formattedFiles = files?.map(file => ({\r\n      id: file.id,\r\n      name: file.name,\r\n      size: file.size,\r\n      mime_type: file.mime_type,\r\n      source: file.source,\r\n      processed: file.processed,\r\n      processing_status: file.processing_status,\r\n      external_url: file.external_url,\r\n      created_at: file.created_at,\r\n      updated_at: file.updated_at,\r\n      metadata: file.metadata,\r\n    })) || []\r\n    \r\n    // Create paginated response\r\n    const paginatedResponse = createPaginatedResponse(\r\n      formattedFiles,\r\n      count || 0,\r\n      pagination\r\n    )\r\n    \r\n    // Log usage\r\n    logApiUsage(user.id, '/api/upload/files', 'files_list', {\r\n      filters: { source, processed, search },\r\n      pagination,\r\n    })\r\n    \r\n    return ApiResponse.success(paginatedResponse)\r\n    \r\n  } catch (error) {\r\n    console.error('List files handler error:', error)\r\n    return ApiResponse.internalError('Failed to process files request')\r\n  }\r\n}\r\n\r\n// Export handler with middleware\r\nexport const GET = createProtectedApiHandler(listFilesHandler, {\r\n  rateLimit: rateLimitConfigs.general,\r\n  logging: {\r\n    enabled: true,\r\n    includeBody: false,\r\n  },\r\n})"],"mappings":"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","ignoreList":[]}