{"version":3,"sources":["R:\\Apps\\Briefly_Cloud\\briefly-cloud-nextjs\\tests\\security\\setup.ts"],"sourcesContent":["/**\r\n * Security Test Setup\r\n * \r\n * Global setup configuration for security tests including:\r\n * - Test environment initialization\r\n * - Mock configurations\r\n * - Security test utilities\r\n * - Database and Redis setup for testing\r\n */\r\n\r\nimport { jest } from '@jest/globals';\r\n\r\n// Extend Jest matchers for security testing\r\nexpect.extend({\r\n  toBeSecurelyHashed(received: string) {\r\n    const pass = received && received.length >= 60 && received.startsWith('$2b$');\r\n    return {\r\n      message: () => `expected ${received} to be a securely hashed password`,\r\n      pass\r\n    };\r\n  },\r\n\r\n  toBeValidJWT(received: string) {\r\n    const jwtPattern = /^[A-Za-z0-9-_]+\\.[A-Za-z0-9-_]+\\.[A-Za-z0-9-_]+$/;\r\n    const pass = jwtPattern.test(received);\r\n    return {\r\n      message: () => `expected ${received} to be a valid JWT token`,\r\n      pass\r\n    };\r\n  },\r\n\r\n  toBeSecureUrl(received: string) {\r\n    const pass = received && received.startsWith('https://');\r\n    return {\r\n      message: () => `expected ${received} to be a secure HTTPS URL`,\r\n      pass\r\n    };\r\n  },\r\n\r\n  toHaveSecurityHeaders(received: Headers) {\r\n    const requiredHeaders = [\r\n      'strict-transport-security',\r\n      'content-security-policy',\r\n      'x-frame-options',\r\n      'x-content-type-options'\r\n    ];\r\n    \r\n    const missingHeaders = requiredHeaders.filter(header => \r\n      !received.has(header)\r\n    );\r\n    \r\n    const pass = missingHeaders.length === 0;\r\n    return {\r\n      message: () => `expected headers to include security headers: ${missingHeaders.join(', ')}`,\r\n      pass\r\n    };\r\n  },\r\n\r\n  toBeWithinRateLimit(received: number, limit: number) {\r\n    const pass = received <= limit;\r\n    return {\r\n      message: () => `expected ${received} to be within rate limit of ${limit}`,\r\n      pass\r\n    };\r\n  }\r\n});\r\n\r\n// Global test configuration\r\nbeforeAll(async () => {\r\n  // Set test environment variables\r\n  process.env.NODE_ENV = 'test';\r\n  process.env.SECURITY_TEST_MODE = 'true';\r\n  \r\n  // Mock external services for security testing\r\n  setupSecurityMocks();\r\n  \r\n  // Initialize test database if needed\r\n  await initializeTestDatabase();\r\n  \r\n  // Setup Redis mock for rate limiting tests\r\n  setupRedisMocks();\r\n});\r\n\r\nafterAll(async () => {\r\n  // Cleanup test resources\r\n  await cleanupTestResources();\r\n});\r\n\r\nbeforeEach(() => {\r\n  // Reset all mocks before each test\r\n  jest.clearAllMocks();\r\n  \r\n  // Reset security test state\r\n  resetSecurityTestState();\r\n});\r\n\r\nafterEach(() => {\r\n  // Cleanup after each test\r\n  cleanupTestState();\r\n});\r\n\r\nfunction setupSecurityMocks() {\r\n  // Mock Supabase client\r\n  jest.mock('@supabase/supabase-js', () => ({\r\n    createClient: jest.fn(() => ({\r\n      auth: {\r\n        getUser: jest.fn(),\r\n        signInWithPassword: jest.fn(),\r\n        signOut: jest.fn(),\r\n        refreshSession: jest.fn(),\r\n        getSession: jest.fn()\r\n      },\r\n      from: jest.fn(() => ({\r\n        select: jest.fn(() => ({\r\n          eq: jest.fn(() => ({\r\n            single: jest.fn(),\r\n            limit: jest.fn()\r\n          })),\r\n          gte: jest.fn(() => ({\r\n            lte: jest.fn(() => ({\r\n              order: jest.fn()\r\n            }))\r\n          }))\r\n        })),\r\n        insert: jest.fn(),\r\n        update: jest.fn(() => ({\r\n          eq: jest.fn()\r\n        })),\r\n        delete: jest.fn(() => ({\r\n          eq: jest.fn()\r\n        }))\r\n      })),\r\n      rpc: jest.fn(),\r\n      channel: jest.fn(() => ({\r\n        on: jest.fn().mockReturnThis(),\r\n        subscribe: jest.fn()\r\n      }))\r\n    }))\r\n  }));\r\n\r\n  // Mock Redis client for rate limiting\r\n  jest.mock('redis', () => ({\r\n    createClient: jest.fn(() => ({\r\n      get: jest.fn(),\r\n      set: jest.fn(),\r\n      incr: jest.fn(),\r\n      expire: jest.fn(),\r\n      del: jest.fn(),\r\n      exists: jest.fn(),\r\n      ttl: jest.fn(),\r\n      multi: jest.fn(() => ({\r\n        incr: jest.fn().mockReturnThis(),\r\n        expire: jest.fn().mockReturnThis(),\r\n        exec: jest.fn()\r\n      }))\r\n    }))\r\n  }));\r\n\r\n  // Mock OpenAI for security testing\r\n  jest.mock('openai', () => ({\r\n    OpenAI: jest.fn(() => ({\r\n      chat: {\r\n        completions: {\r\n          create: jest.fn()\r\n        }\r\n      },\r\n      embeddings: {\r\n        create: jest.fn()\r\n      }\r\n    }))\r\n  }));\r\n\r\n  // Mock Next.js API utilities\r\n  jest.mock('next/server', () => ({\r\n    NextRequest: jest.fn(),\r\n    NextResponse: {\r\n      json: jest.fn((data, init) => ({\r\n        json: () => Promise.resolve(data),\r\n        status: init?.status || 200,\r\n        headers: new Headers(init?.headers)\r\n      })),\r\n      redirect: jest.fn()\r\n    }\r\n  }));\r\n}\r\n\r\nfunction setupRedisMocks() {\r\n  // Setup Redis mock responses for rate limiting tests\r\n  const redisMock = {\r\n    rateLimitData: new Map<string, { count: number; expiry: number }>(),\r\n    \r\n    get: jest.fn((key: string) => {\r\n      const data = redisMock.rateLimitData.get(key);\r\n      if (!data || Date.now() > data.expiry) {\r\n        return Promise.resolve(null);\r\n      }\r\n      return Promise.resolve(data.count.toString());\r\n    }),\r\n    \r\n    incr: jest.fn((key: string) => {\r\n      const data = redisMock.rateLimitData.get(key) || { count: 0, expiry: Date.now() + 60000 };\r\n      data.count++;\r\n      redisMock.rateLimitData.set(key, data);\r\n      return Promise.resolve(data.count);\r\n    }),\r\n    \r\n    expire: jest.fn((key: string, seconds: number) => {\r\n      const data = redisMock.rateLimitData.get(key);\r\n      if (data) {\r\n        data.expiry = Date.now() + (seconds * 1000);\r\n        redisMock.rateLimitData.set(key, data);\r\n      }\r\n      return Promise.resolve(1);\r\n    }),\r\n    \r\n    del: jest.fn((key: string) => {\r\n      const deleted = redisMock.rateLimitData.delete(key);\r\n      return Promise.resolve(deleted ? 1 : 0);\r\n    })\r\n  };\r\n\r\n  // Make mock available globally for tests\r\n  (global as any).redisMock = redisMock;\r\n}\r\n\r\nasync function initializeTestDatabase() {\r\n  // Initialize test database if needed\r\n  // This would typically set up a test-specific database instance\r\n  console.log('Initializing test database for security tests...');\r\n  \r\n  // Mock database initialization\r\n  (global as any).testDatabase = {\r\n    users: new Map(),\r\n    files: new Map(),\r\n    conversations: new Map(),\r\n    auditLogs: new Map(),\r\n    usageLogs: new Map()\r\n  };\r\n}\r\n\r\nfunction resetSecurityTestState() {\r\n  // Reset any global security test state\r\n  if ((global as any).testDatabase) {\r\n    (global as any).testDatabase.users.clear();\r\n    (global as any).testDatabase.files.clear();\r\n    (global as any).testDatabase.conversations.clear();\r\n    (global as any).testDatabase.auditLogs.clear();\r\n    (global as any).testDatabase.usageLogs.clear();\r\n  }\r\n  \r\n  if ((global as any).redisMock) {\r\n    (global as any).redisMock.rateLimitData.clear();\r\n  }\r\n}\r\n\r\nfunction cleanupTestState() {\r\n  // Cleanup any test-specific state\r\n  // Reset timers, clear intervals, etc.\r\n  jest.clearAllTimers();\r\n}\r\n\r\nasync function cleanupTestResources() {\r\n  // Cleanup test resources\r\n  console.log('Cleaning up security test resources...');\r\n  \r\n  // Clear global test objects\r\n  delete (global as any).testDatabase;\r\n  delete (global as any).redisMock;\r\n}\r\n\r\n// Security test utilities\r\nexport const SecurityTestUtils = {\r\n  // Generate test data\r\n  generateTestUser: (overrides = {}) => ({\r\n    id: `test-user-${Date.now()}`,\r\n    email: `test-${Date.now()}@example.com`,\r\n    subscription_tier: 'free',\r\n    created_at: new Date().toISOString(),\r\n    ...overrides\r\n  }),\r\n\r\n  // Generate test tokens\r\n  generateTestToken: (payload = {}) => {\r\n    const header = Buffer.from(JSON.stringify({ alg: 'HS256', typ: 'JWT' })).toString('base64url');\r\n    const testPayload = Buffer.from(JSON.stringify({\r\n      sub: 'test-user',\r\n      iat: Math.floor(Date.now() / 1000),\r\n      exp: Math.floor(Date.now() / 1000) + 3600,\r\n      ...payload\r\n    })).toString('base64url');\r\n    const signature = 'test-signature';\r\n    \r\n    return `${header}.${testPayload}.${signature}`;\r\n  },\r\n\r\n  // Security assertion helpers\r\n  assertSecureResponse: (response: any) => {\r\n    expect(response.headers).toHaveSecurityHeaders();\r\n    if (response.headers.get('set-cookie')) {\r\n      expect(response.headers.get('set-cookie')).toContain('HttpOnly');\r\n      expect(response.headers.get('set-cookie')).toContain('Secure');\r\n    }\r\n  },\r\n\r\n  // Rate limiting test helpers\r\n  simulateRateLimitExceeded: (key: string, limit: number) => {\r\n    const redisMock = (global as any).redisMock;\r\n    if (redisMock) {\r\n      redisMock.rateLimitData.set(key, { \r\n        count: limit + 1, \r\n        expiry: Date.now() + 60000 \r\n      });\r\n    }\r\n  },\r\n\r\n  // Authentication test helpers\r\n  mockAuthenticatedUser: (user: any) => {\r\n    const mockSupabase = require('@supabase/supabase-js').createClient();\r\n    mockSupabase.auth.getUser.mockResolvedValue({\r\n      data: { user },\r\n      error: null\r\n    });\r\n    return mockSupabase;\r\n  },\r\n\r\n  // Audit logging test helpers\r\n  expectAuditLog: (action: string, userId: string) => {\r\n    const testDatabase = (global as any).testDatabase;\r\n    if (testDatabase) {\r\n      const auditLogs = Array.from(testDatabase.auditLogs.values());\r\n      const matchingLog = auditLogs.find(log => \r\n        log.action === action && log.user_id === userId\r\n      );\r\n      expect(matchingLog).toBeDefined();\r\n    }\r\n  }\r\n};\r\n\r\n// Make utilities available globally\r\n(global as any).SecurityTestUtils = SecurityTestUtils;\r\n\r\n// Console override for cleaner test output\r\nconst originalConsoleError = console.error;\r\nconsole.error = (...args: any[]) => {\r\n  // Suppress expected error messages in tests\r\n  const message = args[0];\r\n  if (typeof message === 'string') {\r\n    const suppressedMessages = [\r\n      'Warning: ReactDOM.render is deprecated',\r\n      'Warning: componentWillReceiveProps has been renamed'\r\n    ];\r\n    \r\n    if (suppressedMessages.some(suppressed => message.includes(suppressed))) {\r\n      return;\r\n    }\r\n  }\r\n  \r\n  originalConsoleError.apply(console, args);\r\n};"],"names":["SecurityTestUtils","expect","extend","toBeSecurelyHashed","received","pass","length","startsWith","message","toBeValidJWT","jwtPattern","test","toBeSecureUrl","toHaveSecurityHeaders","requiredHeaders","missingHeaders","filter","header","has","join","toBeWithinRateLimit","limit","beforeAll","process","env","NODE_ENV","SECURITY_TEST_MODE","setupSecurityMocks","initializeTestDatabase","setupRedisMocks","afterAll","cleanupTestResources","beforeEach","jest","clearAllMocks","resetSecurityTestState","afterEach","cleanupTestState","mock","createClient","fn","auth","getUser","signInWithPassword","signOut","refreshSession","getSession","from","select","eq","single","gte","lte","order","insert","update","delete","rpc","channel","on","mockReturnThis","subscribe","get","set","incr","expire","del","exists","ttl","multi","exec","OpenAI","chat","completions","create","embeddings","NextRequest","NextResponse","json","data","init","Promise","resolve","status","headers","Headers","redirect","redisMock","rateLimitData","Map","key","Date","now","expiry","count","toString","seconds","deleted","global","console","log","testDatabase","users","files","conversations","auditLogs","usageLogs","clear","clearAllTimers","generateTestUser","overrides","id","email","subscription_tier","created_at","toISOString","generateTestToken","payload","Buffer","JSON","stringify","alg","typ","testPayload","sub","iat","Math","floor","exp","signature","assertSecureResponse","response","toContain","simulateRateLimitExceeded","mockAuthenticatedUser","user","mockSupabase","require","mockResolvedValue","error","expectAuditLog","action","userId","Array","values","matchingLog","find","user_id","toBeDefined","originalConsoleError","args","suppressedMessages","some","suppressed","includes","apply"],"mappings":"AAAA;;;;;;;;CAQC;;;;+BAuQYA;;;eAAAA;;;yBArQQ;AAErB,4CAA4C;AAC5CC,OAAOC,MAAM,CAAC;IACZC,oBAAmBC,QAAgB;QACjC,MAAMC,OAAOD,YAAYA,SAASE,MAAM,IAAI,MAAMF,SAASG,UAAU,CAAC;QACtE,OAAO;YACLC,SAAS,IAAM,CAAC,SAAS,EAAEJ,SAAS,iCAAiC,CAAC;YACtEC;QACF;IACF;IAEAI,cAAaL,QAAgB;QAC3B,MAAMM,aAAa;QACnB,MAAML,OAAOK,WAAWC,IAAI,CAACP;QAC7B,OAAO;YACLI,SAAS,IAAM,CAAC,SAAS,EAAEJ,SAAS,wBAAwB,CAAC;YAC7DC;QACF;IACF;IAEAO,eAAcR,QAAgB;QAC5B,MAAMC,OAAOD,YAAYA,SAASG,UAAU,CAAC;QAC7C,OAAO;YACLC,SAAS,IAAM,CAAC,SAAS,EAAEJ,SAAS,yBAAyB,CAAC;YAC9DC;QACF;IACF;IAEAQ,uBAAsBT,QAAiB;QACrC,MAAMU,kBAAkB;YACtB;YACA;YACA;YACA;SACD;QAED,MAAMC,iBAAiBD,gBAAgBE,MAAM,CAACC,CAAAA,SAC5C,CAACb,SAASc,GAAG,CAACD;QAGhB,MAAMZ,OAAOU,eAAeT,MAAM,KAAK;QACvC,OAAO;YACLE,SAAS,IAAM,CAAC,8CAA8C,EAAEO,eAAeI,IAAI,CAAC,OAAO;YAC3Fd;QACF;IACF;IAEAe,qBAAoBhB,QAAgB,EAAEiB,KAAa;QACjD,MAAMhB,OAAOD,YAAYiB;QACzB,OAAO;YACLb,SAAS,IAAM,CAAC,SAAS,EAAEJ,SAAS,4BAA4B,EAAEiB,OAAO;YACzEhB;QACF;IACF;AACF;AAEA,4BAA4B;AAC5BiB,UAAU;IACR,iCAAiC;IACjCC,QAAQC,GAAG,CAACC,QAAQ,GAAG;IACvBF,QAAQC,GAAG,CAACE,kBAAkB,GAAG;IAEjC,8CAA8C;IAC9CC;IAEA,qCAAqC;IACrC,MAAMC;IAEN,2CAA2C;IAC3CC;AACF;AAEAC,SAAS;IACP,yBAAyB;IACzB,MAAMC;AACR;AAEAC,WAAW;IACT,mCAAmC;IACnCC,aAAI,CAACC,aAAa;IAElB,4BAA4B;IAC5BC;AACF;AAEAC,UAAU;IACR,0BAA0B;IAC1BC;AACF;AAEA,SAASV;IACP,uBAAuB;IACvBM,aAAI,CAACK,IAAI,CAAC,yBAAyB,IAAO,CAAA;YACxCC,cAAcN,aAAI,CAACO,EAAE,CAAC,IAAO,CAAA;oBAC3BC,MAAM;wBACJC,SAAST,aAAI,CAACO,EAAE;wBAChBG,oBAAoBV,aAAI,CAACO,EAAE;wBAC3BI,SAASX,aAAI,CAACO,EAAE;wBAChBK,gBAAgBZ,aAAI,CAACO,EAAE;wBACvBM,YAAYb,aAAI,CAACO,EAAE;oBACrB;oBACAO,MAAMd,aAAI,CAACO,EAAE,CAAC,IAAO,CAAA;4BACnBQ,QAAQf,aAAI,CAACO,EAAE,CAAC,IAAO,CAAA;oCACrBS,IAAIhB,aAAI,CAACO,EAAE,CAAC,IAAO,CAAA;4CACjBU,QAAQjB,aAAI,CAACO,EAAE;4CACfnB,OAAOY,aAAI,CAACO,EAAE;wCAChB,CAAA;oCACAW,KAAKlB,aAAI,CAACO,EAAE,CAAC,IAAO,CAAA;4CAClBY,KAAKnB,aAAI,CAACO,EAAE,CAAC,IAAO,CAAA;oDAClBa,OAAOpB,aAAI,CAACO,EAAE;gDAChB,CAAA;wCACF,CAAA;gCACF,CAAA;4BACAc,QAAQrB,aAAI,CAACO,EAAE;4BACfe,QAAQtB,aAAI,CAACO,EAAE,CAAC,IAAO,CAAA;oCACrBS,IAAIhB,aAAI,CAACO,EAAE;gCACb,CAAA;4BACAgB,QAAQvB,aAAI,CAACO,EAAE,CAAC,IAAO,CAAA;oCACrBS,IAAIhB,aAAI,CAACO,EAAE;gCACb,CAAA;wBACF,CAAA;oBACAiB,KAAKxB,aAAI,CAACO,EAAE;oBACZkB,SAASzB,aAAI,CAACO,EAAE,CAAC,IAAO,CAAA;4BACtBmB,IAAI1B,aAAI,CAACO,EAAE,GAAGoB,cAAc;4BAC5BC,WAAW5B,aAAI,CAACO,EAAE;wBACpB,CAAA;gBACF,CAAA;QACF,CAAA;IAEA,sCAAsC;IACtCP,aAAI,CAACK,IAAI,CAAC,SAAS,IAAO,CAAA;YACxBC,cAAcN,aAAI,CAACO,EAAE,CAAC,IAAO,CAAA;oBAC3BsB,KAAK7B,aAAI,CAACO,EAAE;oBACZuB,KAAK9B,aAAI,CAACO,EAAE;oBACZwB,MAAM/B,aAAI,CAACO,EAAE;oBACbyB,QAAQhC,aAAI,CAACO,EAAE;oBACf0B,KAAKjC,aAAI,CAACO,EAAE;oBACZ2B,QAAQlC,aAAI,CAACO,EAAE;oBACf4B,KAAKnC,aAAI,CAACO,EAAE;oBACZ6B,OAAOpC,aAAI,CAACO,EAAE,CAAC,IAAO,CAAA;4BACpBwB,MAAM/B,aAAI,CAACO,EAAE,GAAGoB,cAAc;4BAC9BK,QAAQhC,aAAI,CAACO,EAAE,GAAGoB,cAAc;4BAChCU,MAAMrC,aAAI,CAACO,EAAE;wBACf,CAAA;gBACF,CAAA;QACF,CAAA;IAEA,mCAAmC;IACnCP,aAAI,CAACK,IAAI,CAAC,UAAU,IAAO,CAAA;YACzBiC,QAAQtC,aAAI,CAACO,EAAE,CAAC,IAAO,CAAA;oBACrBgC,MAAM;wBACJC,aAAa;4BACXC,QAAQzC,aAAI,CAACO,EAAE;wBACjB;oBACF;oBACAmC,YAAY;wBACVD,QAAQzC,aAAI,CAACO,EAAE;oBACjB;gBACF,CAAA;QACF,CAAA;IAEA,6BAA6B;IAC7BP,aAAI,CAACK,IAAI,CAAC,eAAe,IAAO,CAAA;YAC9BsC,aAAa3C,aAAI,CAACO,EAAE;YACpBqC,cAAc;gBACZC,MAAM7C,aAAI,CAACO,EAAE,CAAC,CAACuC,MAAMC,OAAU,CAAA;wBAC7BF,MAAM,IAAMG,QAAQC,OAAO,CAACH;wBAC5BI,QAAQH,MAAMG,UAAU;wBACxBC,SAAS,IAAIC,QAAQL,MAAMI;oBAC7B,CAAA;gBACAE,UAAUrD,aAAI,CAACO,EAAE;YACnB;QACF,CAAA;AACF;AAEA,SAASX;IACP,qDAAqD;IACrD,MAAM0D,YAAY;QAChBC,eAAe,IAAIC;QAEnB3B,KAAK7B,aAAI,CAACO,EAAE,CAAC,CAACkD;YACZ,MAAMX,OAAOQ,UAAUC,aAAa,CAAC1B,GAAG,CAAC4B;YACzC,IAAI,CAACX,QAAQY,KAAKC,GAAG,KAAKb,KAAKc,MAAM,EAAE;gBACrC,OAAOZ,QAAQC,OAAO,CAAC;YACzB;YACA,OAAOD,QAAQC,OAAO,CAACH,KAAKe,KAAK,CAACC,QAAQ;QAC5C;QAEA/B,MAAM/B,aAAI,CAACO,EAAE,CAAC,CAACkD;YACb,MAAMX,OAAOQ,UAAUC,aAAa,CAAC1B,GAAG,CAAC4B,QAAQ;gBAAEI,OAAO;gBAAGD,QAAQF,KAAKC,GAAG,KAAK;YAAM;YACxFb,KAAKe,KAAK;YACVP,UAAUC,aAAa,CAACzB,GAAG,CAAC2B,KAAKX;YACjC,OAAOE,QAAQC,OAAO,CAACH,KAAKe,KAAK;QACnC;QAEA7B,QAAQhC,aAAI,CAACO,EAAE,CAAC,CAACkD,KAAaM;YAC5B,MAAMjB,OAAOQ,UAAUC,aAAa,CAAC1B,GAAG,CAAC4B;YACzC,IAAIX,MAAM;gBACRA,KAAKc,MAAM,GAAGF,KAAKC,GAAG,KAAMI,UAAU;gBACtCT,UAAUC,aAAa,CAACzB,GAAG,CAAC2B,KAAKX;YACnC;YACA,OAAOE,QAAQC,OAAO,CAAC;QACzB;QAEAhB,KAAKjC,aAAI,CAACO,EAAE,CAAC,CAACkD;YACZ,MAAMO,UAAUV,UAAUC,aAAa,CAAChC,MAAM,CAACkC;YAC/C,OAAOT,QAAQC,OAAO,CAACe,UAAU,IAAI;QACvC;IACF;IAEA,yCAAyC;IACxCC,OAAeX,SAAS,GAAGA;AAC9B;AAEA,eAAe3D;IACb,qCAAqC;IACrC,gEAAgE;IAChEuE,QAAQC,GAAG,CAAC;IAEZ,+BAA+B;IAC9BF,OAAeG,YAAY,GAAG;QAC7BC,OAAO,IAAIb;QACXc,OAAO,IAAId;QACXe,eAAe,IAAIf;QACnBgB,WAAW,IAAIhB;QACfiB,WAAW,IAAIjB;IACjB;AACF;AAEA,SAAStD;IACP,uCAAuC;IACvC,IAAI,AAAC+D,OAAeG,YAAY,EAAE;QAC/BH,OAAeG,YAAY,CAACC,KAAK,CAACK,KAAK;QACvCT,OAAeG,YAAY,CAACE,KAAK,CAACI,KAAK;QACvCT,OAAeG,YAAY,CAACG,aAAa,CAACG,KAAK;QAC/CT,OAAeG,YAAY,CAACI,SAAS,CAACE,KAAK;QAC3CT,OAAeG,YAAY,CAACK,SAAS,CAACC,KAAK;IAC9C;IAEA,IAAI,AAACT,OAAeX,SAAS,EAAE;QAC5BW,OAAeX,SAAS,CAACC,aAAa,CAACmB,KAAK;IAC/C;AACF;AAEA,SAAStE;IACP,kCAAkC;IAClC,sCAAsC;IACtCJ,aAAI,CAAC2E,cAAc;AACrB;AAEA,eAAe7E;IACb,yBAAyB;IACzBoE,QAAQC,GAAG,CAAC;IAEZ,4BAA4B;IAC5B,OAAO,AAACF,OAAeG,YAAY;IACnC,OAAO,AAACH,OAAeX,SAAS;AAClC;AAGO,MAAMvF,oBAAoB;IAC/B,qBAAqB;IACrB6G,kBAAkB,CAACC,YAAY,CAAC,CAAC,GAAM,CAAA;YACrCC,IAAI,CAAC,UAAU,EAAEpB,KAAKC,GAAG,IAAI;YAC7BoB,OAAO,CAAC,KAAK,EAAErB,KAAKC,GAAG,GAAG,YAAY,CAAC;YACvCqB,mBAAmB;YACnBC,YAAY,IAAIvB,OAAOwB,WAAW;YAClC,GAAGL,SAAS;QACd,CAAA;IAEA,uBAAuB;IACvBM,mBAAmB,CAACC,UAAU,CAAC,CAAC;QAC9B,MAAMpG,SAASqG,OAAOvE,IAAI,CAACwE,KAAKC,SAAS,CAAC;YAAEC,KAAK;YAASC,KAAK;QAAM,IAAI3B,QAAQ,CAAC;QAClF,MAAM4B,cAAcL,OAAOvE,IAAI,CAACwE,KAAKC,SAAS,CAAC;YAC7CI,KAAK;YACLC,KAAKC,KAAKC,KAAK,CAACpC,KAAKC,GAAG,KAAK;YAC7BoC,KAAKF,KAAKC,KAAK,CAACpC,KAAKC,GAAG,KAAK,QAAQ;YACrC,GAAGyB,OAAO;QACZ,IAAItB,QAAQ,CAAC;QACb,MAAMkC,YAAY;QAElB,OAAO,GAAGhH,OAAO,CAAC,EAAE0G,YAAY,CAAC,EAAEM,WAAW;IAChD;IAEA,6BAA6B;IAC7BC,sBAAsB,CAACC;QACrBlI,OAAOkI,SAAS/C,OAAO,EAAEvE,qBAAqB;QAC9C,IAAIsH,SAAS/C,OAAO,CAACtB,GAAG,CAAC,eAAe;YACtC7D,OAAOkI,SAAS/C,OAAO,CAACtB,GAAG,CAAC,eAAesE,SAAS,CAAC;YACrDnI,OAAOkI,SAAS/C,OAAO,CAACtB,GAAG,CAAC,eAAesE,SAAS,CAAC;QACvD;IACF;IAEA,6BAA6B;IAC7BC,2BAA2B,CAAC3C,KAAarE;QACvC,MAAMkE,YAAY,AAACW,OAAeX,SAAS;QAC3C,IAAIA,WAAW;YACbA,UAAUC,aAAa,CAACzB,GAAG,CAAC2B,KAAK;gBAC/BI,OAAOzE,QAAQ;gBACfwE,QAAQF,KAAKC,GAAG,KAAK;YACvB;QACF;IACF;IAEA,8BAA8B;IAC9B0C,uBAAuB,CAACC;QACtB,MAAMC,eAAeC,QAAQ,yBAAyBlG,YAAY;QAClEiG,aAAa/F,IAAI,CAACC,OAAO,CAACgG,iBAAiB,CAAC;YAC1C3D,MAAM;gBAAEwD;YAAK;YACbI,OAAO;QACT;QACA,OAAOH;IACT;IAEA,6BAA6B;IAC7BI,gBAAgB,CAACC,QAAgBC;QAC/B,MAAMzC,eAAe,AAACH,OAAeG,YAAY;QACjD,IAAIA,cAAc;YAChB,MAAMI,YAAYsC,MAAMhG,IAAI,CAACsD,aAAaI,SAAS,CAACuC,MAAM;YAC1D,MAAMC,cAAcxC,UAAUyC,IAAI,CAAC9C,CAAAA,MACjCA,IAAIyC,MAAM,KAAKA,UAAUzC,IAAI+C,OAAO,KAAKL;YAE3C7I,OAAOgJ,aAAaG,WAAW;QACjC;IACF;AACF;AAEA,oCAAoC;AACnClD,OAAelG,iBAAiB,GAAGA;AAEpC,2CAA2C;AAC3C,MAAMqJ,uBAAuBlD,QAAQwC,KAAK;AAC1CxC,QAAQwC,KAAK,GAAG,CAAC,GAAGW;IAClB,4CAA4C;IAC5C,MAAM9I,UAAU8I,IAAI,CAAC,EAAE;IACvB,IAAI,OAAO9I,YAAY,UAAU;QAC/B,MAAM+I,qBAAqB;YACzB;YACA;SACD;QAED,IAAIA,mBAAmBC,IAAI,CAACC,CAAAA,aAAcjJ,QAAQkJ,QAAQ,CAACD,cAAc;YACvE;QACF;IACF;IAEAJ,qBAAqBM,KAAK,CAACxD,SAASmD;AACtC"}