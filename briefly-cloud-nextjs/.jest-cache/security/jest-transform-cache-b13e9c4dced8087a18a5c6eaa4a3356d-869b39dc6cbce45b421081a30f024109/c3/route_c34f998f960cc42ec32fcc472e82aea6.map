{"version":3,"names":["POST","chatSchema","cov_17u0ppyqud","s","_zod","z","object","message","string","min","max","conversationId","uuid","optional","stream","boolean","default","chatHandler","request","context","f","user","b","_apiutils","ApiResponse","unauthorized","body","json","catch","parsed","safeParse","success","badRequest","data","supabase","_supabase","supabaseAdmin","convoId","from","insert","user_id","id","title","slice","select","single","conversation_id","role","content","searchDocuments","Promise","resolve","then","_interop_require_wildcard","require","contextResults","_performance","withApiPerformanceMonitoring","limit","threshold","contextText","map","r","i","fileName","chunkIndex","similarity","toFixed","join","systemPrompt","messages","tier","subscription_tier","streamResp","_openai","streamChatCompletion","encoder","TextEncoder","readable","ReadableStream","start","controller","chunk","enqueue","encode","String","close","_server","NextResponse","headers","completion","generateChatCompletion","sources","file_id","fileId","file_name","chunk_index","relevance_score","relevanceScore","response","withPerformanceMonitoring","_apimiddleware","createProtectedApiHandler","rateLimit","_ratelimit","rateLimitConfigs","chat","logging","enabled","includeBody"],"sources":["R:\\Apps\\Briefly_Cloud\\briefly-cloud-nextjs\\src\\app\\api\\chat\\route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\r\nimport { createProtectedApiHandler, ApiContext } from '@/app/lib/api-middleware'\r\nimport { ApiResponse } from '@/app/lib/api-utils'\r\nimport { rateLimitConfigs } from '@/app/lib/rate-limit'\r\nimport { z } from 'zod'\r\nimport { searchDocumentContext } from '@/app/lib/vector-storage'\r\nimport { generateChatCompletion, streamChatCompletion, SubscriptionTier } from '@/app/lib/openai'\r\nimport { supabaseAdmin } from '@/app/lib/supabase'\r\nimport { cacheManager, CACHE_KEYS } from '@/app/lib/cache'\r\nimport { withPerformanceMonitoring, withApiPerformanceMonitoring } from '@/app/lib/performance'\r\n\r\nconst chatSchema = z.object({\r\n  message: z.string().min(1).max(2000),\r\n  conversationId: z.string().uuid().optional(),\r\n  stream: z.boolean().optional().default(true),\r\n})\r\n\r\nasync function chatHandler(request: Request, context: ApiContext): Promise<NextResponse> {\r\n  const { user } = context\r\n  if (!user) return ApiResponse.unauthorized('User not authenticated')\r\n\r\n  const body = await request.json().catch(() => ({}))\r\n  const parsed = chatSchema.safeParse(body)\r\n  if (!parsed.success) return ApiResponse.badRequest('Invalid request data')\r\n\r\n  const { message, conversationId, stream } = parsed.data\r\n\r\n  const supabase = supabaseAdmin\r\n\r\n  // Prepare conversation\r\n  let convoId = conversationId\r\n  if (!convoId) {\r\n    const { data } = await supabase\r\n      .from('conversations')\r\n      .insert({ user_id: user.id, title: message.slice(0, 80) })\r\n      .select('id')\r\n      .single()\r\n    convoId = data?.id\r\n  }\r\n\r\n  // Save user message\r\n  if (convoId) {\r\n    await supabase\r\n      .from('chat_messages')\r\n      .insert({ conversation_id: convoId, role: 'user', content: message })\r\n  }\r\n\r\n  // Retrieve context via new vector search with performance monitoring\r\n  const { searchDocuments } = await import('@/app/lib/vector/document-processor')\r\n  const contextResults = await withApiPerformanceMonitoring(() =>\r\n    searchDocuments(user.id, message, {\r\n      limit: 5,\r\n      threshold: 0.7,\r\n    })\r\n  )\r\n\r\n  const contextText = contextResults\r\n    .map((r, i) => `Source ${i + 1} [${r.fileName} #${r.chunkIndex} | score=${r.similarity.toFixed(2)}]\\n${r.content}`)\r\n    .join('\\n\\n')\r\n\r\n  const systemPrompt = `You are Briefly, an AI assistant. Use the provided document context when relevant.\\n\\nContext:\\n${contextText || 'No relevant context found.'}\\n\\nIf the context is insufficient, say so explicitly. Cite filenames when referencing sources.`\r\n\r\n  const messages = [\r\n    { role: 'system', content: systemPrompt },\r\n    { role: 'user', content: message },\r\n  ] as any\r\n\r\n  const tier = (user.subscription_tier || 'free') as SubscriptionTier\r\n\r\n  if (stream) {\r\n    const streamResp = await withApiPerformanceMonitoring(() =>\r\n      streamChatCompletion(messages, tier)\r\n    )\r\n    \r\n    // Pipe through a basic text stream response\r\n    const encoder = new TextEncoder()\r\n    const readable = new ReadableStream({\r\n      async start(controller) {\r\n        for await (const chunk of streamResp) {\r\n          controller.enqueue(encoder.encode(typeof chunk === 'string' ? chunk : String(chunk)))\r\n        }\r\n        controller.close()\r\n      },\r\n    })\r\n\r\n    return new NextResponse(readable, {\r\n      headers: {\r\n        'Content-Type': 'text/plain; charset=utf-8',\r\n        'Cache-Control': 'no-cache',\r\n      },\r\n    })\r\n  }\r\n\r\n  const completion = await withApiPerformanceMonitoring(() =>\r\n    generateChatCompletion(messages, tier)\r\n  )\r\n\r\n  if (convoId) {\r\n    await supabase\r\n      .from('chat_messages')\r\n      .insert({ \r\n        conversation_id: convoId, \r\n        role: 'assistant', \r\n        content: completion, \r\n        sources: contextResults.map(r => ({ \r\n          file_id: r.fileId, \r\n          file_name: r.fileName, \r\n          chunk_index: r.chunkIndex, \r\n          relevance_score: r.relevanceScore \r\n        })) \r\n      })\r\n  }\r\n\r\n  return ApiResponse.success({\r\n    conversation_id: convoId,\r\n    response: completion,\r\n    sources: contextResults,\r\n  })\r\n}\r\n\r\nexport const POST = withPerformanceMonitoring(\r\n  createProtectedApiHandler(chatHandler, {\r\n    rateLimit: rateLimitConfigs.chat,\r\n    logging: { enabled: true, includeBody: true },\r\n  })\r\n)\r\n\r\n\r\n\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}