{"version":3,"names":["POST","importOneDriveFileHandler","request","context","cov_13jt1td74n","f","user","s","b","_apiutils","ApiResponse","unauthorized","body","json","catch","fileId","badRequest","data","token","_supabase","supabaseAdmin","from","select","eq","id","single","access_token","metaResp","fetch","headers","Authorization","ok","internalError","meta","dl","arrayBuf","arrayBuffer","buffer","Buffer","created","insert","user_id","name","path","size","Number","byteLength","mime_type","file","mimeType","source","external_id","external_url","webUrl","processed","processing_status","metadata","provider","extraction","_documentextractor","extractTextFromBuffer","processDocument","Promise","resolve","then","_interop_require_wildcard","require","text","externalId","importedAt","Date","toISOString","success","file_id","_apimiddleware","createProtectedApiHandler","rateLimit","_ratelimit","rateLimitConfigs","embedding","logging","enabled","includeBody"],"sources":["R:\\Apps\\Briefly_Cloud\\briefly-cloud-nextjs\\src\\app\\api\\storage\\microsoft\\import\\route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\r\nimport { createProtectedApiHandler, ApiContext } from '@/app/lib/api-middleware'\r\nimport { ApiResponse } from '@/app/lib/api-utils'\r\nimport { rateLimitConfigs } from '@/app/lib/rate-limit'\r\nimport { supabaseAdmin } from '@/app/lib/supabase'\r\nimport { extractTextFromBuffer, createTextChunks } from '@/app/lib/document-extractor'\r\nimport { storeDocumentChunks } from '@/app/lib/document-chunker'\r\nimport { createEmbeddingsService } from '@/app/lib/embeddings'\r\nimport { storeDocumentVectors } from '@/app/lib/vector-storage'\r\n\r\nasync function importOneDriveFileHandler(request: Request, context: ApiContext): Promise<NextResponse> {\r\n  const { user } = context\r\n  if (!user) return ApiResponse.unauthorized('User not authenticated')\r\n  const body = await request.json().catch(() => ({})) as { fileId?: string }\r\n  if (!body.fileId) return ApiResponse.badRequest('fileId is required')\r\n\r\n  const { data: token } = await supabaseAdmin\r\n    .from('oauth_tokens')\r\n    .select('*')\r\n    .eq('user_id', user.id)\r\n    .eq('provider', 'microsoft')\r\n    .single()\r\n\r\n  if (!token?.access_token) return ApiResponse.badRequest('Microsoft account not connected')\r\n\r\n  // Get metadata\r\n  const metaResp = await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${body.fileId}`, {\r\n    headers: { Authorization: `Bearer ${token.access_token}` },\r\n  })\r\n  if (!metaResp.ok) return ApiResponse.internalError('Failed to fetch file metadata')\r\n  const meta = await metaResp.json()\r\n\r\n  // Download\r\n  const dl = await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${body.fileId}/content`, {\r\n    headers: { Authorization: `Bearer ${token.access_token}` },\r\n  })\r\n  if (!dl.ok) return ApiResponse.internalError('Failed to download file')\r\n  const arrayBuf = await dl.arrayBuffer()\r\n  const buffer = Buffer.from(arrayBuf)\r\n\r\n  const { data: created } = await supabaseAdmin\r\n    .from('file_metadata')\r\n    .insert({\r\n      user_id: user.id,\r\n      name: meta.name,\r\n      path: `onedrive:${meta.id}`,\r\n      size: Number(meta.size || buffer.byteLength),\r\n      mime_type: meta.file?.mimeType || 'application/octet-stream',\r\n      source: 'microsoft',\r\n      external_id: meta.id,\r\n      external_url: meta.webUrl,\r\n      processed: false,\r\n      processing_status: 'pending',\r\n      metadata: { provider: 'microsoft' },\r\n    })\r\n    .select()\r\n    .single()\r\n\r\n  const fileId = created.id\r\n  const extraction = await extractTextFromBuffer(buffer, created.mime_type, created.name)\r\n  \r\n  const { processDocument } = await import('@/app/lib/vector/document-processor')\r\n  await processDocument(user.id, fileId, created.name, extraction.text, {\r\n    source: 'microsoft_onedrive',\r\n    mimeType: created.mime_type,\r\n    externalId: body.fileId,\r\n    importedAt: new Date().toISOString()\r\n  })\r\n\r\n  return ApiResponse.success({ file_id: fileId, name: created.name })\r\n}\r\n\r\nexport const POST = createProtectedApiHandler(importOneDriveFileHandler, {\r\n  rateLimit: rateLimitConfigs.embedding,\r\n  logging: { enabled: true, includeBody: true },\r\n})\r\n\r\n\r\n\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;+BAwEa;;;;;;WAAAA,IAAA;;;;;kCAvEyC;;;kCAC1B;;;kCACK;;;kCACH;;;kCAC0B;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAKxD,eAAeC,0BAA0BC,OAAgB,EAAEC,OAAmB;EAAA;EAAAC,cAAA,GAAAC,CAAA;EAC5E,MAAM;IAAEC;EAAI,CAAE;EAAA;EAAA,CAAAF,cAAA,GAAAG,CAAA,QAAGJ,OAAA;EAAA;EAAAC,cAAA,GAAAG,CAAA;EACjB,IAAI,CAACD,IAAA,EAAM;IAAA;IAAAF,cAAA,GAAAI,CAAA;IAAAJ,cAAA,GAAAG,CAAA;IAAA,OAAOE,SAAA,CAAAC,WAAW,CAACC,YAAY,CAAC;EAAA;EAAA;EAAA;IAAAP,cAAA,GAAAI,CAAA;EAAA;EAC3C,MAAMI,IAAA;EAAA;EAAA,CAAAR,cAAA,GAAAG,CAAA,QAAO,MAAML,OAAA,CAAQW,IAAI,GAAGC,KAAK,CAAC,MAAO;IAAA;IAAAV,cAAA,GAAAC,CAAA;IAAAD,cAAA,GAAAG,CAAA;IAAA,QAAC;EAAA;EAAA;EAAAH,cAAA,GAAAG,CAAA;EAChD,IAAI,CAACK,IAAA,CAAKG,MAAM,EAAE;IAAA;IAAAX,cAAA,GAAAI,CAAA;IAAAJ,cAAA,GAAAG,CAAA;IAAA,OAAOE,SAAA,CAAAC,WAAW,CAACM,UAAU,CAAC;EAAA;EAAA;EAAA;IAAAZ,cAAA,GAAAI,CAAA;EAAA;EAEhD,MAAM;IAAES,IAAA,EAAMC;EAAK,CAAE;EAAA;EAAA,CAAAd,cAAA,GAAAG,CAAA,QAAG,MAAMY,SAAA,CAAAC,aAAa,CACxCC,IAAI,CAAC,gBACLC,MAAM,CAAC,KACPC,EAAE,CAAC,WAAWjB,IAAA,CAAKkB,EAAE,EACrBD,EAAE,CAAC,YAAY,aACfE,MAAM;EAAA;EAAArB,cAAA,GAAAG,CAAA;EAET,IAAI,CAACW,KAAA,EAAOQ,YAAA,EAAc;IAAA;IAAAtB,cAAA,GAAAI,CAAA;IAAAJ,cAAA,GAAAG,CAAA;IAAA,OAAOE,SAAA,CAAAC,WAAW,CAACM,UAAU,CAAC;EAAA;EAAA;EAAA;IAAAZ,cAAA,GAAAI,CAAA;EAAA;EAExD;EACA,MAAMmB,QAAA;EAAA;EAAA,CAAAvB,cAAA,GAAAG,CAAA,QAAW,MAAMqB,KAAA,CAAM,mDAAmDhB,IAAA,CAAKG,MAAM,EAAE,EAAE;IAC7Fc,OAAA,EAAS;MAAEC,aAAA,EAAe,UAAUZ,KAAA,CAAMQ,YAAY;IAAG;EAC3D;EAAA;EAAAtB,cAAA,GAAAG,CAAA;EACA,IAAI,CAACoB,QAAA,CAASI,EAAE,EAAE;IAAA;IAAA3B,cAAA,GAAAI,CAAA;IAAAJ,cAAA,GAAAG,CAAA;IAAA,OAAOE,SAAA,CAAAC,WAAW,CAACsB,aAAa,CAAC;EAAA;EAAA;EAAA;IAAA5B,cAAA,GAAAI,CAAA;EAAA;EACnD,MAAMyB,IAAA;EAAA;EAAA,CAAA7B,cAAA,GAAAG,CAAA,QAAO,MAAMoB,QAAA,CAASd,IAAI;EAEhC;EACA,MAAMqB,EAAA;EAAA;EAAA,CAAA9B,cAAA,GAAAG,CAAA,QAAK,MAAMqB,KAAA,CAAM,mDAAmDhB,IAAA,CAAKG,MAAM,UAAU,EAAE;IAC/Fc,OAAA,EAAS;MAAEC,aAAA,EAAe,UAAUZ,KAAA,CAAMQ,YAAY;IAAG;EAC3D;EAAA;EAAAtB,cAAA,GAAAG,CAAA;EACA,IAAI,CAAC2B,EAAA,CAAGH,EAAE,EAAE;IAAA;IAAA3B,cAAA,GAAAI,CAAA;IAAAJ,cAAA,GAAAG,CAAA;IAAA,OAAOE,SAAA,CAAAC,WAAW,CAACsB,aAAa,CAAC;EAAA;EAAA;EAAA;IAAA5B,cAAA,GAAAI,CAAA;EAAA;EAC7C,MAAM2B,QAAA;EAAA;EAAA,CAAA/B,cAAA,GAAAG,CAAA,QAAW,MAAM2B,EAAA,CAAGE,WAAW;EACrC,MAAMC,MAAA;EAAA;EAAA,CAAAjC,cAAA,GAAAG,CAAA,QAAS+B,MAAA,CAAOjB,IAAI,CAACc,QAAA;EAE3B,MAAM;IAAElB,IAAA,EAAMsB;EAAO,CAAE;EAAA;EAAA,CAAAnC,cAAA,GAAAG,CAAA,QAAG,MAAMY,SAAA,CAAAC,aAAa,CAC1CC,IAAI,CAAC,iBACLmB,MAAM,CAAC;IACNC,OAAA,EAASnC,IAAA,CAAKkB,EAAE;IAChBkB,IAAA,EAAMT,IAAA,CAAKS,IAAI;IACfC,IAAA,EAAM,YAAYV,IAAA,CAAKT,EAAE,EAAE;IAC3BoB,IAAA,EAAMC,MAAA;IAAO;IAAA,CAAAzC,cAAA,GAAAI,CAAA,WAAAyB,IAAA,CAAKW,IAAI;IAAA;IAAA,CAAAxC,cAAA,GAAAI,CAAA,WAAI6B,MAAA,CAAOS,UAAU;IAC3CC,SAAA;IAAW;IAAA,CAAA3C,cAAA,GAAAI,CAAA,WAAAyB,IAAA,CAAKe,IAAI,EAAEC,QAAA;IAAA;IAAA,CAAA7C,cAAA,GAAAI,CAAA,WAAY;IAClC0C,MAAA,EAAQ;IACRC,WAAA,EAAalB,IAAA,CAAKT,EAAE;IACpB4B,YAAA,EAAcnB,IAAA,CAAKoB,MAAM;IACzBC,SAAA,EAAW;IACXC,iBAAA,EAAmB;IACnBC,QAAA,EAAU;MAAEC,QAAA,EAAU;IAAY;EACpC,GACCnC,MAAM,GACNG,MAAM;EAET,MAAMV,MAAA;EAAA;EAAA,CAAAX,cAAA,GAAAG,CAAA,QAASgC,OAAA,CAAQf,EAAE;EACzB,MAAMkC,UAAA;EAAA;EAAA,CAAAtD,cAAA,GAAAG,CAAA,QAAa,MAAM,IAAAoD,kBAAA,CAAAC,qBAAqB,EAACvB,MAAA,EAAQE,OAAA,CAAQQ,SAAS,EAAER,OAAA,CAAQG,IAAI;EAEtF,MAAM;IAAEmB;EAAe,CAAE;EAAA;EAAA,CAAAzD,cAAA,GAAAG,CAAA,QAAG,MAAMuD,OAAA,CAAAC,OAAA,GAAAC,IAAA;IAAA;IAAA5D,cAAA,GAAAC,CAAA;IAAAD,cAAA,GAAAG,CAAA;IAAA,oBAAA0D,yBAAA,CAAAC,OAAA,CAAO;EAAA;EAAA;EAAA9D,cAAA,GAAAG,CAAA;EACzC,MAAMsD,eAAA,CAAgBvD,IAAA,CAAKkB,EAAE,EAAET,MAAA,EAAQwB,OAAA,CAAQG,IAAI,EAAEgB,UAAA,CAAWS,IAAI,EAAE;IACpEjB,MAAA,EAAQ;IACRD,QAAA,EAAUV,OAAA,CAAQQ,SAAS;IAC3BqB,UAAA,EAAYxD,IAAA,CAAKG,MAAM;IACvBsD,UAAA,EAAY,IAAIC,IAAA,GAAOC,WAAW;EACpC;EAAA;EAAAnE,cAAA,GAAAG,CAAA;EAEA,OAAOE,SAAA,CAAAC,WAAW,CAAC8D,OAAO,CAAC;IAAEC,OAAA,EAAS1D,MAAA;IAAQ2B,IAAA,EAAMH,OAAA,CAAQG;EAAK;AACnE;AAEO,MAAM1C,IAAA;AAAA;AAAA,CAAAI,cAAA,GAAAG,CAAA,QAAO,IAAAmE,cAAA,CAAAC,yBAAyB,EAAC1E,yBAAA,EAA2B;EACvE2E,SAAA,EAAWC,UAAA,CAAAC,gBAAgB,CAACC,SAAS;EACrCC,OAAA,EAAS;IAAEC,OAAA,EAAS;IAAMC,WAAA,EAAa;EAAK;AAC9C","ignoreList":[]}