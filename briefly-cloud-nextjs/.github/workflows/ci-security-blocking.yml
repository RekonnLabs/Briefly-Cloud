name: CI Security Pipeline (Blocking)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened, ready_for_review]

env:
  NODE_VERSION: '20'
  POSTGRES_VERSION: '15'
  POSTGRES_DB: briefly_test
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres

# Cancel in-progress runs for the same workflow and branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Pre-flight security checks that must pass before any other jobs
  security-preflight:
    name: Security Pre-flight Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      security-passed: ${{ steps.security-check.outputs.passed }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for security analysis
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'Briefly_Cloud/briefly-cloud-nextjs/package-lock.json'
      
      - name: Install dependencies
        working-directory: Briefly_Cloud/briefly-cloud-nextjs
        run: |
          npm ci --audit-level=moderate
          npm audit --audit-level=moderate
      
      - name: Secrets detection
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified --fail
      
      - name: Critical security lint
        working-directory: Briefly_Cloud/briefly-cloud-nextjs
        run: |
          npm run lint:security
          npm run security:scan
      
      - name: Environment validation
        working-directory: Briefly_Cloud/briefly-cloud-nextjs
        run: |
          npm run validate:environment
      
      - name: Set security check result
        id: security-check
        run: echo "passed=true" >> $GITHUB_OUTPUT

  # Database setup and migration testing
  database-setup:
    name: Database Setup & Migration
    runs-on: ubuntu-latest
    needs: security-preflight
    timeout-minutes: 15
    
    services:
      postgres:
        image: postgres:${{ env.POSTGRES_VERSION }}
        env:
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'Briefly_Cloud/briefly-cloud-nextjs/package-lock.json'
      
      - name: Install dependencies
        working-directory: Briefly_Cloud/briefly-cloud-nextjs
        run: npm ci
      
      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
      
      - name: Enable pgvector extension
        run: |
          PGPASSWORD=${{ env.POSTGRES_PASSWORD }} psql -h localhost -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -c "CREATE EXTENSION IF NOT EXISTS vector;"
      
      - name: Run database migrations
        working-directory: Briefly_Cloud/briefly-cloud-nextjs
        run: |
          # Run all database migration files in order
          for file in database/*.sql; do
            echo "Running migration: $file"
            PGPASSWORD=${{ env.POSTGRES_PASSWORD }} psql -h localhost -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -f "$file"
          done
        env:
          DATABASE_URL: postgresql://${{ env.POSTGRES_USER }}:${{ env.POSTGRES_PASSWORD }}@localhost:5432/${{ env.POSTGRES_DB }}
      
      - name: Verify database schema
        run: |
          # Check that all expected tables exist
          PGPASSWORD=${{ env.POSTGRES_PASSWORD }} psql -h localhost -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -c "
            SELECT schemaname, tablename 
            FROM pg_tables 
            WHERE schemaname IN ('app', 'private', 'public') 
            ORDER BY schemaname, tablename;
          "
      
      - name: Test RLS policies
        run: |
          # Basic RLS policy test
          PGPASSWORD=${{ env.POSTGRES_PASSWORD }} psql -h localhost -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -c "
            SELECT tablename, rowsecurity 
            FROM pg_tables t 
            JOIN pg_class c ON c.relname = t.tablename 
            WHERE schemaname = 'app' AND c.relrowsecurity = true;
          "

  # Security test suite with database
  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    needs: [security-preflight, database-setup]
    timeout-minutes: 30
    
    strategy:
      fail-fast: true # Fail immediately if any security test fails
      matrix:
        test-suite: [auth, rls, rate-limiting, audit, monitoring, integration]
    
    services:
      postgres:
        image: postgres:${{ env.POSTGRES_VERSION }}
        env:
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'Briefly_Cloud/briefly-cloud-nextjs/package-lock.json'
      
      - name: Install dependencies
        working-directory: Briefly_Cloud/briefly-cloud-nextjs
        run: npm ci
      
      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
      
      - name: Setup test database
        run: |
          PGPASSWORD=${{ env.POSTGRES_PASSWORD }} psql -h localhost -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -c "CREATE EXTENSION IF NOT EXISTS vector;"
          
          # Run database migrations
          for file in Briefly_Cloud/briefly-cloud-nextjs/database/*.sql; do
            echo "Running migration: $file"
            PGPASSWORD=${{ env.POSTGRES_PASSWORD }} psql -h localhost -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -f "$file"
          done
      
      - name: Run security test suite
        working-directory: Briefly_Cloud/briefly-cloud-nextjs
        run: |
          npm run test:security:${{ matrix.test-suite }} -- --coverage --coverageDirectory=coverage/security/${{ matrix.test-suite }} --testResultsProcessor=jest-junit --outputFile=reports/security/jest-results-${{ matrix.test-suite }}.xml --verbose
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://${{ env.POSTGRES_USER }}:${{ env.POSTGRES_PASSWORD }}@localhost:5432/${{ env.POSTGRES_DB }}
          SUPABASE_URL: http://localhost:54321
          SUPABASE_ANON_KEY: test-anon-key
          SUPABASE_SERVICE_ROLE_KEY: test-service-key
          CI: true
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-test-results-${{ matrix.test-suite }}
          path: |
            Briefly_Cloud/briefly-cloud-nextjs/coverage/security/
            Briefly_Cloud/briefly-cloud-nextjs/reports/security/
          retention-days: 30

  # RLS and pgvector specific tests
  rls-pgvector-tests:
    name: RLS & pgvector Integration Tests
    runs-on: ubuntu-latest
    needs: [security-preflight, database-setup]
    timeout-minutes: 20
    
    services:
      postgres:
        image: pgvector/pgvector:pg15
        env:
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'Briefly_Cloud/briefly-cloud-nextjs/package-lock.json'
      
      - name: Install dependencies
        working-directory: Briefly_Cloud/briefly-cloud-nextjs
        run: npm ci
      
      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
      
      - name: Setup test database with pgvector
        run: |
          # Enable pgvector extension
          PGPASSWORD=${{ env.POSTGRES_PASSWORD }} psql -h localhost -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -c "CREATE EXTENSION IF NOT EXISTS vector;"
          
          # Run database migrations
          for file in Briefly_Cloud/briefly-cloud-nextjs/database/*.sql; do
            echo "Running migration: $file"
            PGPASSWORD=${{ env.POSTGRES_PASSWORD }} psql -h localhost -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -f "$file"
          done
      
      - name: Seed test users for RLS testing
        run: |
          PGPASSWORD=${{ env.POSTGRES_PASSWORD }} psql -h localhost -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -c "
            -- Create test users
            INSERT INTO app.users (id, email, full_name, subscription_tier) VALUES 
            ('11111111-1111-1111-1111-111111111111', 'user1@test.com', 'Test User 1', 'free'),
            ('22222222-2222-2222-2222-222222222222', 'user2@test.com', 'Test User 2', 'pro');
            
            -- Create test documents for each user
            INSERT INTO app.files (id, user_id, filename, file_type, file_size, storage_path) VALUES
            ('aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', '11111111-1111-1111-1111-111111111111', 'user1-doc.pdf', 'application/pdf', 1024, 'user1/doc.pdf'),
            ('bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb', '22222222-2222-2222-2222-222222222222', 'user2-doc.pdf', 'application/pdf', 2048, 'user2/doc.pdf');
            
            -- Create test document chunks with embeddings
            INSERT INTO app.document_chunks (id, file_id, user_id, content, embedding, chunk_index) VALUES
            ('cccccccc-cccc-cccc-cccc-cccccccccccc', 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', '11111111-1111-1111-1111-111111111111', 'User 1 content', '[0.1,0.2,0.3]'::vector, 0),
            ('dddddddd-dddd-dddd-dddd-dddddddddddd', 'bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb', '22222222-2222-2222-2222-222222222222', 'User 2 content', '[0.4,0.5,0.6]'::vector, 0);
          "
      
      - name: Test RLS isolation
        run: |
          # Test that users can only see their own data
          echo "Testing RLS isolation..."
          
          # Set user context and test data access
          PGPASSWORD=${{ env.POSTGRES_PASSWORD }} psql -h localhost -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -c "
            -- Set user 1 context
            SELECT set_config('request.jwt.claims', '{\"sub\":\"11111111-1111-1111-1111-111111111111\"}', true);
            
            -- User 1 should only see their own files
            SELECT COUNT(*) as user1_files FROM app.files WHERE user_id = '11111111-1111-1111-1111-111111111111';
            
            -- Set user 2 context  
            SELECT set_config('request.jwt.claims', '{\"sub\":\"22222222-2222-2222-2222-222222222222\"}', true);
            
            -- User 2 should only see their own files
            SELECT COUNT(*) as user2_files FROM app.files WHERE user_id = '22222222-2222-2222-2222-222222222222';
          "
      
      - name: Test vector search with user isolation
        run: |
          # Test that vector searches are user-scoped
          PGPASSWORD=${{ env.POSTGRES_PASSWORD }} psql -h localhost -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -c "
            -- Test vector similarity search with user isolation
            SELECT 
              dc.id,
              dc.user_id,
              dc.content,
              dc.embedding <-> '[0.1,0.2,0.3]'::vector as distance
            FROM app.document_chunks dc
            WHERE dc.user_id = '11111111-1111-1111-1111-111111111111'
            ORDER BY dc.embedding <-> '[0.1,0.2,0.3]'::vector
            LIMIT 5;
          "
      
      - name: Run RLS security tests
        working-directory: Briefly_Cloud/briefly-cloud-nextjs
        run: |
          npm run test:security:rls -- --verbose
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://${{ env.POSTGRES_USER }}:${{ env.POSTGRES_PASSWORD }}@localhost:5432/${{ env.POSTGRES_DB }}
          CI: true

  # Static analysis and linting
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    needs: security-preflight
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'Briefly_Cloud/briefly-cloud-nextjs/package-lock.json'
      
      - name: Install dependencies
        working-directory: Briefly_Cloud/briefly-cloud-nextjs
        run: npm ci
      
      - name: TypeScript compilation check
        working-directory: Briefly_Cloud/briefly-cloud-nextjs
        run: |
          npx tsc --noEmit --strict
      
      - name: ESLint security analysis
        working-directory: Briefly_Cloud/briefly-cloud-nextjs
        run: |
          npm run lint:security
          npm run lint:security -- --format json --output-file eslint-security-report.json
      
      - name: Semgrep security scan
        working-directory: Briefly_Cloud/briefly-cloud-nextjs
        run: |
          npm run security:scan:ci
      
      - name: Upload static analysis results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: static-analysis-results
          path: |
            Briefly_Cloud/briefly-cloud-nextjs/eslint-security-report.json
            Briefly_Cloud/briefly-cloud-nextjs/semgrep-results.json
          retention-days: 30

  # Build validation
  build-validation:
    name: Security Build Validation
    runs-on: ubuntu-latest
    needs: [security-tests, rls-pgvector-tests, static-analysis]
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'Briefly_Cloud/briefly-cloud-nextjs/package-lock.json'
      
      - name: Install dependencies
        working-directory: Briefly_Cloud/briefly-cloud-nextjs
        run: npm ci
      
      - name: Security validation
        working-directory: Briefly_Cloud/briefly-cloud-nextjs
        run: |
          npm run validate:security
          npm run validate:environment
      
      - name: Build with security optimizations
        working-directory: Briefly_Cloud/briefly-cloud-nextjs
        run: |
          npm run build
        env:
          NODE_ENV: production
          SECURITY_HARDENED_BUILD: true
      
      - name: Validate build security
        working-directory: Briefly_Cloud/briefly-cloud-nextjs
        run: |
          npm run validate:build-security

  # Final security gate
  security-gate:
    name: Security Gate
    runs-on: ubuntu-latest
    needs: [security-tests, rls-pgvector-tests, static-analysis, build-validation]
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'Briefly_Cloud/briefly-cloud-nextjs/package-lock.json'
      
      - name: Install dependencies
        working-directory: Briefly_Cloud/briefly-cloud-nextjs
        run: npm ci
      
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: security-artifacts
      
      - name: Run security gate validation
        working-directory: Briefly_Cloud/briefly-cloud-nextjs
        run: |
          npm run security:gate:validate -- --artifacts-path ../security-artifacts
      
      - name: Generate security report
        working-directory: Briefly_Cloud/briefly-cloud-nextjs
        run: |
          npm run security:report -- --artifacts-path ../security-artifacts
      
      - name: Security gate decision
        working-directory: Briefly_Cloud/briefly-cloud-nextjs
        run: |
          # This script will exit with non-zero code if security gate fails
          npm run security:gates:ci
      
      - name: Upload final security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: final-security-report
          path: |
            Briefly_Cloud/briefly-cloud-nextjs/reports/security/
          retention-days: 90

  # Notification on failure
  notify-on-failure:
    name: Notify on Security Failure
    runs-on: ubuntu-latest
    needs: [security-gate]
    if: failure()
    
    steps:
      - name: Notify security team
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#security-alerts'
          text: |
            ðŸš¨ SECURITY PIPELINE FAILED - BLOCKING DEPLOYMENT
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            PR: ${{ github.event.pull_request.html_url }}
            
            This failure blocks all deployments until resolved.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_SECURITY_WEBHOOK }}